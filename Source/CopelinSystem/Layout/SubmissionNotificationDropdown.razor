@using CopelinSystem.Services
@using CopelinSystem.Models
@inject SubmissionTokenService TokenService
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer

@if (CanViewEstimatorTools && recentSubmissions?.Any() == true)
{
    <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#" aria-expanded="false">
            <i class="far fa-bell"></i>
            <span class="badge badge-warning navbar-badge">@recentSubmissions.Count</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right" style="left: inherit; right: 0px;">
            <span class="dropdown-item dropdown-header">@recentSubmissions.Count Submission(s)</span>
            <div class="dropdown-divider"></div>
            @foreach (var sub in recentSubmissions)
            {
                var currentSub = sub;
                <div class="d-flex justify-content-between align-items-center border-bottom">
                    <a href="/projects/view/@currentSub.ProjectId" class="dropdown-item" style="white-space: normal; flex: 1;">
                        <i class="fas fa-file mr-2"></i> <small>@currentSub.ProjectName</small>
                        <br/><small class="text-muted ml-4">WR: @currentSub.ProjectWr - @currentSub.Department - @currentSub.UsedAt?.ToString("dd/MM HH:mm")</small>
                    </a>
                    
                    <span class="text-danger mr-2 px-2" style="cursor: pointer;" @onclick="() => DismissNotification(currentSub.TokenId)" @onclick:preventDefault="true" @onclick:stopPropagation="true" title="Dismiss">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            }
        </div>
    </li>
}

@code {
    [Parameter]
    public bool CanViewEstimatorTools { get; set; }

    private List<SubmissionNotificationDto>? recentSubmissions;

    private int currentUserId;

    protected override async Task OnParametersSetAsync()
    {
        if (CanViewEstimatorTools)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userIdClaim = user.FindFirst("UserId");
            
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUserId = userId;
                await LoadSubmissions();
            }
        }
    }

    private async Task LoadSubmissions()
    {
        if (currentUserId > 0)
        {
            recentSubmissions = await TokenService.GetRecentSubmissions(currentUserId, 3);
        }
    }

    private async Task DismissNotification(Guid tokenId)
    {
        try 
        {
            bool success = await TokenService.DismissNotification(tokenId, currentUserId);
            if (success)
            {
                await LoadSubmissions();
                StateHasChanged();
                // await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", "Notification dismissed");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("Notifications.showError", "Could not dismiss notification.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", "Error dismissing: " + ex.Message);
        }
    }
}
