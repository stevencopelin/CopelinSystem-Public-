@page "/employees"
@using CopelinSystem.Models
@using CopelinSystem.Services
@inject EmployeeService EmployeeService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthenticationService AuthService
@inject PermissionService PermissionService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Employee Management - Copelin Work Flow Management</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (canManageEmployees)
        {
            <div class="container-fluid mt-3">
                <!-- Header -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h3><i class="fas fa-users"></i> Employee Management</h3>
                        <p class="text-muted">Manage employees and their roles (Supervisors, Senior Estimators, Principal Estimators, Planning Managers, Estimators, Read-only, Administrators)</p>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link @(activeTab == "employees" ? "active" : "")" @onclick='() => SetActiveTab("employees")' style="cursor: pointer;">
                            <i class="fas fa-user"></i> Employees
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(activeTab == "roles" ? "active" : "")" @onclick='() => SetActiveTab("roles")' style="cursor: pointer;">
                            <i class="fas fa-user-tag"></i> Role Assignment
                        </a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3">
                    <!-- EMPLOYEES TAB -->
                    @if (activeTab == "employees")
                    {
                        <div class="card">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h4 class="card-title mb-0">Employees</h4>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <select class="form-control d-inline-block w-auto mr-2" @bind="filterRegionId">
                                            <option value="0">-- All Regions --</option>
                                            @if (regions != null)
                                            {
                                                foreach (var region in regions)
                                                {
                                                    <option value="@region.RegionId">@region.RegionName</option>
                                                }
                                            }
                                        </select>
                                        <button class="btn btn-success" @onclick="OpenAddEmployeeModal">
                                            <i class="fas fa-plus"></i> Add Employee
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                @if (employees == null)
                                {
                                    <p>Loading employees...</p>
                                }
                                else if (!GetFilteredEmployees().Any())
                                {
                                    <p class="text-muted">No employees found. Click "Add Employee" to create one.</p>
                                }
                                else
                                {
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Full Name</th>
                                                <th>Region</th>
                                                <th>Roles</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var employee in GetFilteredEmployees())
                                            {
                                                <tr>
                                                    <td>@employee.FullName</td>
                                                    <td>@(employee.Region?.RegionName ?? "-")</td>
                                                    <td>
                                                        @if (employee.EmployeeRoles.Any())
                                                        {
                                                            @string.Join(", ", employee.EmployeeRoles.Select(r => GetRoleName(r.RoleType)))
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">No roles assigned</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (employee.Active)
                                                        {
                                                            <span class="badge badge-success">Active</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge badge-secondary">Inactive</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary" @onclick="() => OpenEditEmployeeModal(employee)">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                        @if (employee.Active)
                                                        {
                                                            <button class="btn btn-sm btn-warning" @onclick="() => DeactivateEmployee(employee.EmployeeId)">
                                                                <i class="fas fa-ban"></i> Deactivate
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-sm btn-success" @onclick="() => ActivateEmployee(employee.EmployeeId)">
                                                                <i class="fas fa-check"></i> Activate
                                                            </button>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    }

                    <!-- ROLES TAB -->
                    @if (activeTab == "roles")
                    {
                        <div class="card">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h4 class="card-title mb-0">Role Assignment</h4>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <select class="form-control d-inline-block w-auto" @bind="filterRegionId">
                                            <option value="0">-- All Regions --</option>
                                            @if (regions != null)
                                            {
                                                foreach (var region in regions)
                                                {
                                                    <option value="@region.RegionId">@region.RegionName</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                @if (employees == null)
                                {
                                    <p>Loading employees...</p>
                                }
                                else if (!GetFilteredEmployees().Where(e => e.Active).Any())
                                {
                                    <p class="text-muted">No active employees found.</p>
                                }
                                else
                                {
                                    <!-- Role Statistics -->
                                    <div class="row mb-3">
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Supervisors</h6>
                                                    <h3>@roleCounts.GetValueOrDefault("Supervisor", 0)</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Senior Estimators</h6>
                                                    <h3>@roleCounts.GetValueOrDefault("Senior Estimator", 0)</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Principal Estimators</h6>
                                                    <h3>@roleCounts.GetValueOrDefault("Principal Estimator", 0)</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Planning Managers</h6>
                                                    <h3>@roleCounts.GetValueOrDefault("Planning Manager", 0)</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Estimators</h6>
                                                    <h3>@roleCounts.GetValueOrDefault("Estimator", 0)</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Read Only</h6>
                                                    <h3>@roleCounts.GetValueOrDefault("Read Only", 0)</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Admins</h6>
                                                    <h3>@roleCounts.GetValueOrDefault("Administrator", 0)</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Role Assignment Table -->
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Employee Name</th>
                                                <th>Region</th>
                                                <th class="text-center">Supervisor</th>
                                                <th class="text-center">Sr. Estimator</th>
                                                <th class="text-center">Principal</th>
                                                <th class="text-center">Planning Mgr</th>
                                                <th class="text-center">Estimator</th>
                                                <th class="text-center">Read Only</th>
                                                <th class="text-center">Admin</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var employee in GetFilteredEmployees().Where(e => e.Active))
                                            {
                                                <tr>
                                                    <td>@employee.FullName</td>
                                                    <td>@(employee.Region?.RegionName ?? "-")</td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               checked="@HasRole(employee, RoleType.Supervisor)"
                                                               @onchange="e => ToggleRole(employee.EmployeeId, RoleType.Supervisor, (bool)(e.Value ?? false))" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               checked="@HasRole(employee, RoleType.SeniorEstimator)"
                                                               @onchange="e => ToggleRole(employee.EmployeeId, RoleType.SeniorEstimator, (bool)(e.Value ?? false))" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               checked="@HasRole(employee, RoleType.PrincipalEstimator)"
                                                               @onchange="e => ToggleRole(employee.EmployeeId, RoleType.PrincipalEstimator, (bool)(e.Value ?? false))" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               checked="@HasRole(employee, RoleType.PlanningManager)"
                                                               @onchange="e => ToggleRole(employee.EmployeeId, RoleType.PlanningManager, (bool)(e.Value ?? false))" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               checked="@HasRole(employee, RoleType.Estimator)"
                                                               @onchange="e => ToggleRole(employee.EmployeeId, RoleType.Estimator, (bool)(e.Value ?? false))" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               checked="@HasRole(employee, RoleType.ReadOnly)"
                                                               @onchange="e => ToggleRole(employee.EmployeeId, RoleType.ReadOnly, (bool)(e.Value ?? false))" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               checked="@HasRole(employee, RoleType.Administrator)"
                                                               @onchange="e => ToggleRole(employee.EmployeeId, RoleType.Administrator, (bool)(e.Value ?? false))" />
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- EMPLOYEE MODAL -->
                @if (showEmployeeModal)
                {
                    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">@(isEditingEmployee ? "Edit Employee" : "Add Employee")</h5>
                                    <button type="button" class="close" @onclick="CloseEmployeeModal">
                                        <span>&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label><strong>Full Name *</strong></label>
                                        <input type="text" class="form-control" @bind="currentEmployee.FullName" placeholder="e.g., John Smith" />
                                    </div>
                                    <div class="form-group">
                                        <label><strong>Region</strong></label>
                                        <select class="form-control" @bind="currentEmployee.RegionId">
                                            <option value="">-- Select Region --</option>
                                            @if (regions != null)
                                            {
                                                foreach (var region in regions)
                                                {
                                                    <option value="@region.RegionId">@region.RegionName</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseEmployeeModal">Cancel</button>
                                    <button type="button" class="btn btn-primary" @onclick="SaveEmployee">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center mt-5">
                <h3>Access Denied</h3>
                <p>You do not have permission to access this page.</p>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h3>Please log in to access this page.</h3>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private User? currentUser;
    private bool canManageEmployees = false;
    private string activeTab = "employees";

    // Data lists
    private List<Employee>? employees;
    private List<Region>? regions;
    private Dictionary<string, int> roleCounts = new();

    // Modal states
    private bool showEmployeeModal = false;
    private bool isEditingEmployee = false;

    // Current entity
    private Employee currentEmployee = new();

    // Filtering
    private int filterRegionId = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUser = await AuthService.GetUserById(userId);
                if (currentUser != null)
                {
                    canManageEmployees = await PermissionService.UserHasPermission(currentUser, "ManageEmployees");
                }
            }
        }

        if (canManageEmployees)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        employees = await EmployeeService.GetAllEmployeesIncludingInactive();
        regions = await EmployeeService.GetAllRegions();
        roleCounts = await EmployeeService.GetEmployeeCountByRole();
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private List<Employee> GetFilteredEmployees()
    {
        if (employees == null) return new List<Employee>();
        
        if (filterRegionId == 0)
            return employees;
        
        return employees.Where(e => e.RegionId == filterRegionId).ToList();
    }

    private string GetRoleName(RoleType roleType)
    {
        return roleType switch
        {
            RoleType.Supervisor => "Supervisor",
            RoleType.SeniorEstimator => "Senior Estimator",
            RoleType.PrincipalEstimator => "Principal Estimator",
            RoleType.PlanningManager => "Planning Manager",
            RoleType.Estimator => "Estimator",
            RoleType.ReadOnly => "Read Only",
            RoleType.Administrator => "Administrator",
            _ => "Unknown"
        };
    }

    private bool HasRole(Employee employee, RoleType roleType)
    {
        return employee.EmployeeRoles.Any(r => r.RoleType == roleType);
    }

    private async Task ToggleRole(int employeeId, RoleType roleType, bool isChecked)
    {
        if (isChecked)
        {
            await EmployeeService.AddEmployeeRole(employeeId, roleType);
        }
        else
        {
            await EmployeeService.RemoveEmployeeRole(employeeId, roleType);
        }

        await LoadData();
    }

    // ==================== EMPLOYEE METHODS ====================

    private void OpenAddEmployeeModal()
    {
        currentEmployee = new Employee();
        isEditingEmployee = false;
        showEmployeeModal = true;
    }

    private void OpenEditEmployeeModal(Employee employee)
    {
        currentEmployee = new Employee
        {
            EmployeeId = employee.EmployeeId,
            FullName = employee.FullName,
            RegionId = employee.RegionId,
            Active = employee.Active
        };
        isEditingEmployee = true;
        showEmployeeModal = true;
    }

    private void CloseEmployeeModal()
    {
        showEmployeeModal = false;
        currentEmployee = new();
    }

    private async Task SaveEmployee()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.FullName))
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", "Employee name is required");
            return;
        }

        if (isEditingEmployee)
        {
            await EmployeeService.UpdateEmployee(currentEmployee);
        }
        else
        {
            await EmployeeService.AddEmployee(currentEmployee);
        }

        await LoadData();
        CloseEmployeeModal();
    }

    private async Task DeactivateEmployee(int employeeId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("Notifications.showConfirm", "Deactivate this employee? They will no longer appear in dropdowns.");
        if (confirmed)
        {
            await EmployeeService.DeleteEmployee(employeeId);
            await LoadData();
        }
    }

    private async Task ActivateEmployee(int employeeId)
    {
        await EmployeeService.ActivateEmployee(employeeId);
        await LoadData();
    }
}
