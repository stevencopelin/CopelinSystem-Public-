@page "/admin/iso-forms"
@using CopelinSystem.Models
@using CopelinSystem.Services
@inject ChecklistService ChecklistService
@inject NavigationManager Navigation

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>ISO Form Templates</h1>
            </div>
            <div class="col-sm-6">
                <button class="btn btn-primary float-sm-right" @onclick="CreateNewTemplate">
                    <i class="fas fa-plus"></i> New Template
                </button>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-body p-0">
                <table class="table table-striped projects">
                    <thead>
                        <tr>
                            <th style="width: 40%">Name & Description</th>
                            <th style="width: 15%">Category</th>
                            <th style="width: 10%">Version</th>
                            <th style="width: 10%">Sections</th>
                            <th style="width: 10%">Status</th>
                            <th style="width: 15%" class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (templates == null)
                        {
                            <tr><td colspan="6">Loading...</td></tr>
                        }
                        else if (!templates.Any())
                        {
                            <tr><td colspan="6">No templates found.</td></tr>
                        }
                        else
                        {
                            foreach (var template in templates)
                            {
                                <tr>
                                    <td>
                                        <h6 class="mb-1 font-weight-bold">@template.Name</h6>
                                        <small class="text-muted d-block text-truncate" style="max-width: 500px;" title="@template.Description">
                                            @template.Description
                                        </small>
                                    </td>
                                    <td class="align-middle">@template.Category</td>
                                    <td class="align-middle">@template.Version</td>
                                    <td class="align-middle">@template.Sections?.Count</td>
                                    <td class="align-middle">
                                        <span class="badge @(template.IsActive ? "badge-success" : "badge-secondary")">
                                            @(template.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td class="text-right align-middle">
                                        <a href="/admin/iso-forms/edit/@template.TemplateId" class="btn btn-info btn-sm mr-1">
                                            <i class="fas fa-pencil-alt"></i> Edit
                                        </a>
                                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteTemplate(template.TemplateId)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

@code {
    private List<ChecklistTemplate>? templates;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
    }

    private async Task LoadTemplates()
    {
        templates = await ChecklistService.GetAllTemplatesAsync();
    }

    private async Task CreateNewTemplate()
    {
        var newTemplate = new ChecklistTemplate
        {
            Name = "New Template",
            Category = "General",
            CreatedBy = "Admin", // TODO: Get current user
            CreatedDate = DateTime.Now
        };
        
        var created = await ChecklistService.CreateTemplateAsync(newTemplate);
        Navigation.NavigateTo($"/admin/iso-forms/edit/{created.TemplateId}");
    }

    private async Task DeleteTemplate(int id)
    {
        // TODO: confirm dialog
        await ChecklistService.DeleteTemplateAsync(id);
        await LoadTemplates();
    }
}
