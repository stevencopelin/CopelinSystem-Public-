@page "/consultants"
@using CopelinSystem.Models
@using CopelinSystem.Services
@inject ConsultantService ConsultantService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthenticationService AuthService
@inject PermissionService PermissionService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Consultant Management - Copelin Work Flow Management</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (canManageConsultants)
        {
            <div class="container-fluid mt-3">
                <!-- Header -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h3><i class="fas fa-user-tie"></i> Consultant Management</h3>
                        <p class="text-muted">Manage consultants and their contact information</p>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="row mb-3">
                    <div class="col-md-12 text-right">
                        <button class="btn btn-success" @onclick="OpenAddModal">
                            <i class="fas fa-plus"></i> Add Consultant
                        </button>
                    </div>
                </div>

                <!-- Consultants Table -->
                <div class="card">
                    <div class="card-body">
                        @if (consultants == null)
                        {
                            <p>Loading consultants...</p>
                        }
                        else if (!consultants.Any())
                        {
                            <p class="text-muted">No consultants found. Click "Add Consultant" to create one.</p>
                        }
                        else
                        {
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Business Name</th>
                                        <th>Contact Person</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Services</th>
                                        <th>Supplier #</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var consultant in consultants)
                                    {
                                        <tr>
                                            <td><strong>@consultant.BusinessName</strong></td>
                                            <td>@(consultant.Contact ?? "-")</td>
                                            <td>@(consultant.Email ?? "-")</td>
                                            <td>@(consultant.Phone ?? "-")</td>
                                            <td>@(consultant.Services ?? "-")</td>
                                            <td>@(consultant.SupplierNumber ?? "-")</td>
                                            <td>
                                                @if (consultant.IsActive)
                                                {
                                                    <span class="badge badge-success">Active</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-secondary">Inactive</span>
                                                }
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" @onclick="() => OpenEditModal(consultant)">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                @if (consultant.IsActive)
                                                {
                                                    <button class="btn btn-sm btn-warning" @onclick="() => DeactivateConsultant(consultant.ConsultantId)">
                                                        <i class="fas fa-ban"></i> Deactivate
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-success" @onclick="() => ActivateConsultant(consultant.ConsultantId)">
                                                        <i class="fas fa-check"></i> Activate
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>

                <!-- Add/Edit Modal -->
                @if (showModal)
                {
                    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">@(isEditing ? "Edit Consultant" : "Add Consultant")</h5>
                                    <button type="button" class="close" @onclick="CloseModal">
                                        <span>&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label><strong>Business Name *</strong></label>
                                        <input type="text" class="form-control" @bind="currentConsultant.BusinessName" placeholder="e.g., ABC Consulting Pty Ltd" />
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><strong>Contact Person</strong></label>
                                                <input type="text" class="form-control" @bind="currentConsultant.Contact" placeholder="e.g., John Smith" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><strong>Supplier Number</strong></label>
                                                <input type="text" class="form-control" @bind="currentConsultant.SupplierNumber" placeholder="e.g., SUP-12345" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><strong>Email</strong></label>
                                                <input type="email" class="form-control" @bind="currentConsultant.Email" placeholder="contact@example.com" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><strong>Phone</strong></label>
                                                <input type="text" class="form-control" @bind="currentConsultant.Phone" placeholder="0400 000 000" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label><strong>Address</strong></label>
                                        <textarea class="form-control" rows="2" @bind="currentConsultant.Address" placeholder="Business address"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label><strong>Services</strong></label>
                                        <textarea class="form-control" rows="3" @bind="currentConsultant.Services" placeholder="Description of services provided"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                                    <button type="button" class="btn btn-primary" @onclick="SaveConsultant">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center mt-5">
                <h3>Access Denied</h3>
                <p>You do not have permission to access this page.</p>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h3>Please log in to access this page.</h3>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private User? currentUser;
    private bool canManageConsultants = false;
    private List<Consultant>? consultants;
    private bool showModal = false;
    private bool isEditing = false;
    private Consultant currentConsultant = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUser = await AuthService.GetUserById(userId);
                if (currentUser != null)
                {
                    canManageConsultants = await PermissionService.UserHasPermission(currentUser, "ManageConsultants");
                }
            }
        }

        if (canManageConsultants)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        consultants = await ConsultantService.GetAllConsultants(includeInactive: true);
    }

    private void OpenAddModal()
    {
        currentConsultant = new Consultant();
        isEditing = false;
        showModal = true;
    }

    private void OpenEditModal(Consultant consultant)
    {
        currentConsultant = new Consultant
        {
            ConsultantId = consultant.ConsultantId,
            BusinessName = consultant.BusinessName,
            Contact = consultant.Contact,
            Email = consultant.Email,
            Phone = consultant.Phone,
            Address = consultant.Address,
            Services = consultant.Services,
            SupplierNumber = consultant.SupplierNumber,
            IsActive = consultant.IsActive
        };
        isEditing = true;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        currentConsultant = new();
    }

    private async Task SaveConsultant()
    {
        if (string.IsNullOrWhiteSpace(currentConsultant.BusinessName))
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", "Business name is required");
            return;
        }

        if (isEditing)
        {
            await ConsultantService.UpdateConsultant(currentConsultant);
        }
        else
        {
            await ConsultantService.AddConsultant(currentConsultant);
        }

        await LoadData();
        CloseModal();
    }

    private async Task DeactivateConsultant(int consultantId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("Notifications.showConfirm", "Deactivate this consultant? It will no longer appear in dropdowns.");
        if (confirmed)
        {
            await ConsultantService.DeleteConsultant(consultantId);
            await LoadData();
        }
    }

    private async Task ActivateConsultant(int consultantId)
    {
        var consultant = consultants?.FirstOrDefault(c => c.ConsultantId == consultantId);
        if (consultant != null)
        {
            consultant.IsActive = true;
            await ConsultantService.UpdateConsultant(consultant);
            await LoadData();
        }
    }
}
