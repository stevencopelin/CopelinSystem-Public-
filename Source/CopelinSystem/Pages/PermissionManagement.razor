@page "/permissions"
@using CopelinSystem.Models
@using CopelinSystem.Services
@inject PermissionService PermissionService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthenticationService AuthService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Permission Management - Copelin Work Flow Management</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (canManagePermissions)
        {
            <div class="container-fluid mt-3">
                <!-- Header -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h3><i class="fas fa-shield-alt"></i> Permission Management</h3>
                        <p class="text-muted">Configure role-based permissions for the system</p>
                    </div>
                </div>

                @if (isLoading)
                {
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                        <p class="mt-3">Loading permissions...</p>
                    </div>
                }
                else if (permissionsByCategory != null && permissionMatrix != null)
                {
                    <!-- Save/Reset Buttons -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <button class="btn btn-primary" @onclick="SaveChanges" disabled="@(!hasChanges)">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button class="btn btn-secondary ml-2" @onclick="LoadData" disabled="@(!hasChanges)">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            @if (hasChanges)
                            {
                                <span class="badge badge-warning ml-2">Unsaved Changes</span>
                            }
                        </div>
                    </div>

                    <!-- Permission Matrix -->
                    <div class="card">
                        <div class="card-body">
                            @foreach (var category in permissionsByCategory.OrderBy(c => c.Key))
                            {
                                <h5 class="border-bottom pb-2 mb-3 mt-3">
                                    <i class="fas fa-folder-open"></i> @category.Key
                                </h5>
                                
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th style="width: 30%;">Permission</th>
                                                <th class="text-center">Read Only</th>
                                                <th class="text-center">Estimator</th>
                                                <th class="text-center">Manager</th>
                                                <th class="text-center">Principal</th>
                                                <th class="text-center">Admin</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var permission in category.Value)
                                            {
                                                <tr>
                                                    <td>
                                                        <strong>@permission.DisplayName</strong>
                                                        @if (!string.IsNullOrEmpty(permission.Description))
                                                        {
                                                            <br />
                                                            <small class="text-muted">@permission.Description</small>
                                                        }
                                                    </td>
                                                    @foreach (UserRole role in Enum.GetValues(typeof(UserRole)))
                                                    {
                                                        <td class="text-center">
                                                            <input type="checkbox" 
                                                                   checked="@IsPermissionGranted(role, permission.PermissionId)"
                                                                   @onchange="@(e => TogglePermission(role, permission.PermissionId, (bool)e.Value!))"
                                                                   class="form-check-input" />
                                                        </td>
                                                    }
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> <strong>Note:</strong> Changes are not saved until you click the "Save Changes" button. 
                                Permissions control what each role can access throughout the system.
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center mt-5">
                <h3>Access Denied</h3>
                <p>You do not have permission to access this page.</p>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h3>Please log in to access this page.</h3>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private User? currentUser;
    private bool canManagePermissions = false;
    private Dictionary<string, List<Permission>>? permissionsByCategory;
    private Dictionary<UserRole, List<PermissionWithStatus>>? permissionMatrix;
    private Dictionary<UserRole, List<PermissionWithStatus>>? originalMatrix;
    private bool isLoading = true;
    private bool hasChanges = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUser = await AuthService.GetUserById(userId);
                if (currentUser != null)
                {
                    canManagePermissions = await PermissionService.UserHasPermission(currentUser, "ManagePermissions");
                }
            }
        }

        if (canManagePermissions)
        {
            await LoadData();
        }
        
        isLoading = false;
    }

    private async Task LoadData()
    {
        isLoading = true;
        permissionsByCategory = await PermissionService.GetPermissionsByCategory();
        permissionMatrix = await PermissionService.GetPermissionMatrix();
        
        // Create a deep copy for change tracking
        originalMatrix = new Dictionary<UserRole, List<PermissionWithStatus>>();
        foreach (var kvp in permissionMatrix)
        {
            originalMatrix[kvp.Key] = kvp.Value.Select(p => new PermissionWithStatus
            {
                PermissionId = p.PermissionId,
                PermissionName = p.PermissionName,
                Category = p.Category,
                DisplayName = p.DisplayName,
                Description = p.Description,
                IsGranted = p.IsGranted
            }).ToList();
        }
        
        hasChanges = false;
        isLoading = false;
    }

    private bool IsPermissionGranted(UserRole role, int permissionId)
    {
        if (permissionMatrix == null) return false;
        
        var rolePermissions = permissionMatrix[role];
        var permission = rolePermissions.FirstOrDefault(p => p.PermissionId == permissionId);
        return permission?.IsGranted ?? false;
    }

    private void TogglePermission(UserRole role, int permissionId, bool isGranted)
    {
        if (permissionMatrix == null) return;
        
        var rolePermissions = permissionMatrix[role];
        var permission = rolePermissions.FirstOrDefault(p => p.PermissionId == permissionId);
        
        if (permission != null)
        {
            permission.IsGranted = isGranted;
            CheckForChanges();
        }
    }

    private void CheckForChanges()
    {
        if (permissionMatrix == null || originalMatrix == null)
        {
            hasChanges = false;
            return;
        }

        foreach (var role in permissionMatrix.Keys)
        {
            var current = permissionMatrix[role];
            var original = originalMatrix[role];

            for (int i = 0; i < current.Count; i++)
            {
                if (current[i].IsGranted != original[i].IsGranted)
                {
                    hasChanges = true;
                    return;
                }
            }
        }

        hasChanges = false;
    }

    private async Task SaveChanges()
    {
        if (permissionMatrix == null || originalMatrix == null) return;

        bool confirmed = await JSRuntime.InvokeAsync<bool>("Notifications.showConfirm", 
            "Are you sure you want to save these permission changes? This will affect what users can access in the system.");
        
        if (!confirmed) return;

        try
        {
            // Find and save all changes
            foreach (var role in permissionMatrix.Keys)
            {
                var current = permissionMatrix[role];
                var original = originalMatrix[role];

                for (int i = 0; i < current.Count; i++)
                {
                    if (current[i].IsGranted != original[i].IsGranted)
                    {
                        await PermissionService.UpdateRolePermission(role, current[i].PermissionId, current[i].IsGranted);
                    }
                }
            }

            // Clear all permission caches
            PermissionService.ClearCache();
            
            // Clear authentication state cache to force re-evaluation of permissions
            if (AuthStateProvider is CopelinAuthStateProvider copelinProvider)
            {
                copelinProvider.ClearCache();
            }

            await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", "Permissions updated successfully! All users will see the changes on their next page navigation.");
            await LoadData(); // Reload to get fresh data
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", $"Error saving permissions: {ex.Message}");
        }
    }
}
