@page "/projects"
@using CopelinSystem.Models
@using CopelinSystem.Services
@inject ProjectService ProjectService
@inject PermissionService PermissionService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthenticationService AuthService
@inject NavigationManager Navigation
@inject EmailService EmailService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Project Explorer - Copelin Work Flow Management</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="container-fluid mt-3">
            <!-- Header -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <h3><i class="nav-icon fas fa-table"></i> Project Explorer</h3>
                </div>
                <div class="col-md-6 text-right">
                    <!-- Add Project Button -->
                    @if (canCreateProjects)
                    {
                        <a href="/projects/add" class="btn btn-primary mr-2">
                            <i class="fas fa-plus"></i> Add New Project
                        </a>
                    }
                    <!-- Advanced Search Toggle -->
                    <button class="btn btn-success" @onclick="ToggleAdvancedSearch">
                        <i class="fas fa-search"></i> Advanced Search
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="card card-outline card-primary">
                <div class="card-body">
                    <div class="row">
                        <!-- Status Filters -->
                        <div class="col-md-8">
                            <div class="form-group">
                                <div class="custom-control custom-checkbox d-inline mr-3">
                                    <input type="checkbox" class="custom-control-input" id="statusCreated" @bind="showCreated" @bind:after="ApplyFilters">
                                    <label class="custom-control-label" for="statusCreated">Created</label>
                                </div>
                                <div class="custom-control custom-checkbox d-inline mr-3">
                                    <input type="checkbox" class="custom-control-input" id="statusInProgress" @bind="showInProgress" @bind:after="ApplyFilters">
                                    <label class="custom-control-label" for="statusInProgress">In-Progress</label>
                                </div>
                                <div class="custom-control custom-checkbox d-inline mr-3">
                                    <input type="checkbox" class="custom-control-input" id="statusOnHold" @bind="showOnHold" @bind:after="ApplyFilters">
                                    <label class="custom-control-label" for="statusOnHold">On-Hold</label>
                                </div>
                                <div class="custom-control custom-checkbox d-inline mr-3">
                                    <input type="checkbox" class="custom-control-input" id="statusReview" @bind="showReview" @bind:after="ApplyFilters">
                                    <label class="custom-control-label" for="statusReview">Review</label>
                                </div>
                                <div class="custom-control custom-checkbox d-inline mr-3">
                                    <input type="checkbox" class="custom-control-input" id="statusCancelled" @bind="showCancelled" @bind:after="ApplyFilters">
                                    <label class="custom-control-label" for="statusCancelled">Cancelled</label>
                                </div>
                                <div class="custom-control custom-checkbox d-inline mr-3">
                                    <input type="checkbox" class="custom-control-input" id="statusArchive" @bind="showArchive" @bind:after="ApplyFilters">
                                    <label class="custom-control-label" for="statusArchive">Archive</label>
                                </div>
                            </div>
                        </div>
                        <!-- Search & Pagination -->
                        <div class="col-md-4">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">Search:</span>
                                </div>
                    

                                <input type="text" class="form-control" @bind="searchTerm" @bind:event="oninput" @bind:after="ApplyFilters" placeholder="Name, WR, Location..." />
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Filters (Collapsible) -->
                    @if (showAdvancedSearch)
                    {
                        <div class="row mt-3 border-top pt-3 bg-light rounded mx-1">
                            @if (canViewEstimatorFilter)
                            {
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Estimator</label>
                                        <select class="form-control" @bind="selectedEstimatorId" @bind:after="ApplyFilters">
                                            <option value="0">-- All --</option>
                                            @foreach (var estimator in estimators)
                                            {
                                                <option value="@estimator.UserId">@estimator.DisplayName</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            }
                            
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Client</label>
                                    <select class="form-control" @bind="selectedClient" @bind:after="ApplyFilters">
                                        <option value="">-- All --</option>
                                        @foreach (var client in availableClients)
                                        {
                                            <option value="@client">@client</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Works Type</label>
                                    <select class="form-control" @bind="selectedWorksType" @bind:after="ApplyFilters">
                                        <option value="">-- All --</option>
                                        @foreach (var type in availableWorksTypes)
                                        {
                                            <option value="@type">@type</option>
                                        }
                                    </select>
                                </div>
                            </div>
                             <div class="col-md-3">
                                <div class="form-group">
                                    <label>Work Order (WO)</label>
                                    <input type="text" class="form-control" @bind="searchWo" @bind:event="oninput" @bind:after="ApplyFilters" placeholder="WO Number..." />
                                </div>
                            </div>
                        </div>

                        <div class="row mx-1 pb-3 bg-light rounded-bottom">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Purchase Order (PO)</label>
                                    <input type="text" class="form-control" @bind="searchPo" @bind:event="oninput" @bind:after="ApplyFilters" placeholder="PO Number..." />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Created After</label>
                                    <input type="date" class="form-control" @bind="dateFrom" @bind:after="ApplyFilters" />
                                </div>
                            </div>
                             <div class="col-md-3">
                                <div class="form-group">
                                    <label>Created Before</label>
                                    <input type="date" class="form-control" @bind="dateTo" @bind:after="ApplyFilters" />
                                </div>
                            </div>
                             <div class="col-md-3 d-flex align-items-end mb-3">
                                <small class="text-muted w-100 text-right">
                                    <span class="d-block" style="line-height: 1.2;">Use filters to narrow down results.</span>
                                </small>
                            </div>
                        </div>
                    }
                    
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <label class="mr-2">Show</label>
                            <select class="custom-select custom-select-sm form-control form-control-sm d-inline-block" style="width: auto;" @bind="pageSize" @bind:after="ApplyFilters">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <label class="ml-2">entries</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project List Table -->
            <div class="card card-outline card-info">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped projects">
                            <thead>
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 40%">Project Name</th>
                                    <th style="width: 10%">Date Started</th>
                                    <th style="width: 10%">Close of Tender</th>
                                    <th style="width: 10%">Status</th>
                                    <th style="width: 15%">Tasks (Qty)</th>
                                    <th style="width: 10%">Action</th>

                                </tr>
                            </thead>
                            <tbody>
                                @if (isLoading)
                                {
                                    <tr><td colspan="7" class="text-center">Loading projects...</td></tr>
                                }
                                else if (filteredProjects == null || !filteredProjects.Any())
                                {
                                    <tr><td colspan="7" class="text-center">No projects found matching your criteria.</td></tr>
                                }
                                else
                                {
                                    int index = (currentPage - 1) * pageSize + 1;
                                    foreach (var project in pagedProjects)
                                    {
                                        <tr>
                                            <td>@index</td>
                                            <td>
                                                <div class="project-title-cell">
                                                    <div class="mb-1">
                                                        <strong>@project.ProjectWr</strong>
                                                        @if (!string.IsNullOrEmpty(project.ProjectWorkstype))
                                                        {
                                                            <span class="badge @GetWorkstypeBadgeClass(project.ProjectWorkstype) ml-2">@project.ProjectWorkstype</span>
                                                        }
                                                        @if (canViewEstimatorInfo && !string.IsNullOrEmpty(project.ProjectUserIds))
                                                        {
                                                            var estimatorName = GetProjectEstimatorName(project.ProjectUserIds);
                                                            if (!string.IsNullOrEmpty(estimatorName))
                                                            {
                                                                <span class="text-muted ml-2" style="font-size: 0.9em;">
                                                                    <i class="fas fa-user-tag mr-1"></i> @estimatorName
                                                                </span>
                                                            }
                                                        }
                                                    </div>
                                                    <div class="mb-1">
                                                        <a href="/projects/view/@project.ProjectId" class="font-weight-bold text-dark" style="font-size: 1.1em;">
                                                            @(!string.IsNullOrEmpty(project.ProjectLocation) ? $"{project.ProjectLocation} - " : "")@project.ProjectName
                                                        </a>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(project.ProjectDescription))
                                                    {
                                                        <small class="text-muted d-block text-truncate" style="max-width: 400px;">
                                                            @project.ProjectDescription
                                                        </small>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                @(project.ProjectStartDate?.ToString("dd MMM, yyyy") ?? "-")
                                            </td>
                                            <td>
                                                @(project.ProjectEndDate?.ToString("dd MMM, yyyy") ?? "No Close Date")
                                            </td>
                                            <td>
                                                <span class="badge @GetStatusBadgeClass(project.ProjectStatus)">
                                                    @GetStatusText(project.ProjectStatus)
                                                </span>
                                            </td>
                                            <td>
                                                <small>
                                                    <strong>@(projectTaskCounts.ContainsKey(project.ProjectId) ? projectTaskCounts[project.ProjectId] : 0)</strong> - Tasks | 
                                                    <strong>@(projectEmailCounts.ContainsKey(project.ProjectId) ? projectEmailCounts[project.ProjectId] : 0)</strong> - Emails
                                                </small>

                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
                                                        Action
                                                    </button>
                                                    <div class="dropdown-menu">
                                                        <a class="dropdown-item" href="/projects/view/@project.ProjectId">
                                                            <i class="fas fa-eye mr-2"></i> View
                                                        </a>
                                                        @if (canEditProjects)
                                                        {
                                                            <a class="dropdown-item" href="/projects/edit/@project.ProjectId">
                                                                <i class="fas fa-pencil-alt mr-2"></i> Edit
                                                            </a>
                                                        }
                                                        @if (canDeleteProjects)
                                                        {
                                                            <div class="dropdown-divider"></div>
                                                            <button class="dropdown-item text-danger" @onclick="() => ConfirmDelete(project.ProjectId, project.ProjectName)">
                                                                <i class="fas fa-trash mr-2"></i> Delete
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        index++;
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Pagination Footer -->
                <div class="card-footer clearfix">
                    <div class="float-left">
                        Showing @((filteredProjects?.Count ?? 0) > 0 ? (currentPage - 1) * pageSize + 1 : 0) to @Math.Min(currentPage * pageSize, filteredProjects?.Count ?? 0) of @(filteredProjects?.Count ?? 0) entries
                    </div>
                    <ul class="pagination pagination-sm m-0 float-right">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Previous</button>
                        </li>
                        @for (int i = 1; i <= totalPages; i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                            </li>
                        }
                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Next</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h3>Please log in to view projects.</h3>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private User? currentUser;
    private bool canCreateProjects = false;
    private bool canEditProjects = false;
    private bool canDeleteProjects = false;
    private bool isLoading = true;
    
    // Data
    private List<ProjectList> allProjects = new();
    private List<ProjectList> filteredProjects = new();
    private List<ProjectList> pagedProjects = new();
    private Dictionary<int, int> projectTaskCounts = new();
    private Dictionary<int, int> projectEmailCounts = new();
    private Dictionary<int, string> estimatorLookup = new(); // Map of UserID -> DisplayName for Estimators

    // Filters
    private bool showCreated = true;
    private bool showInProgress = true;
    private bool showOnHold = false;
    private bool showReview = false;
    private bool showCancelled = false;
    private bool showArchive = false;
    private string searchTerm = "";
    private bool showAdvancedSearch = false;
    private int selectedEstimatorId = 0;
    private List<User> estimators = new();
    private bool canViewEstimatorFilter = false;
    private bool canViewEstimatorInfo = false;

    // Additional Filters
    private string selectedClient = "";
    private string selectedWorksType = "";
    private string searchWo = "";
    private string searchPo = "";
    private DateTime? dateFrom;
    private DateTime? dateTo;
    
    private List<string> availableClients = new();
    private List<string> availableWorksTypes = new();

    // Pagination
    private int pageSize = 10;
    private int currentPage = 1;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUser = await AuthService.GetUserById(userId);
                if (currentUser != null)
                {
                    canCreateProjects = await PermissionService.UserHasPermission(currentUser, "CreateProjects");
                    canEditProjects = await PermissionService.UserHasPermission(currentUser, "EditProjects");
                    canDeleteProjects = await PermissionService.UserHasPermission(currentUser, "DeleteProjects");
                    
                    // Permission to view Estimator Info (On card) and Filter
                    // Restricted to Principal Estimator (4) and Admin (5)
                    canViewEstimatorInfo = currentUser.Role >= UserRole.PrincipalEstimator;

                    // Setup Estimator Data
                    // Fetch ALL estimators to map their IDs to names for display in the grid
                    var allEmployees = await AuthService.GetAllUsers();
                    var allEstimators = allEmployees.Where(u => u.UserType == (byte)UserRole.Estimator || 
                                                                u.UserType == (byte)UserRole.PrincipalEstimator || 
                                                                u.UserType == (byte)UserRole.Manager).ToList();
                    estimatorLookup = allEstimators.ToDictionary(u => u.UserId, u => u.DisplayName);

                    // Setup Estimator Filter (For logic in filtering)
                    if (canViewEstimatorInfo)
                    {
                        canViewEstimatorFilter = true;
                        // For the dropdown filter, we might want both Estimators and Principal Estimators or just Estimators.
                        // Based on previous code, it was both. Let's keep the filter list as is for now, 
                        // but maybe we should focus on the requested "Estimator" role.
                        // User request specifically asked for "Estimator", so let's stick to that for the Visual Display.
                        // For the filter, we'll keep the logic consistent with what was there (Estimator + Principal) 
                        // unless user asks to change that too. But reusing 'estimators' list is tricky.
                        // Let's reload 'estimators' for the filter specifically to be safe and clear.
                        
                        estimators = allEmployees.Where(u => u.UserType == (byte)UserRole.Estimator || u.UserType == (byte)UserRole.PrincipalEstimator).ToList();
                        
                        // Logic Update per User Request:
                        // 1. Admin/Manager (Global): Show ALL estimators.
                        // 2. Principal Estimator (Regional): Show ONLY estimators in their region (Robust Match).
                        
                        bool isGlobalAccess = currentUser.Role == UserRole.Admin; // Manager removed from global view for specific estimator details if they can't see them? 
                        // Actually, if we restrict view to PrincipalEstimator+, strict Manager (3) can't see this block anyway.
                        // So checking if user is Admin is enough for Global, or if they are PrincipalEstimator with "All" region.
                        
                        // If not global access (i.e. Principal Estimator), restrict by region
                        if (!isGlobalAccess && !string.IsNullOrWhiteSpace(currentUser.Region) && !currentUser.Region.Equals("All", StringComparison.OrdinalIgnoreCase))
                        {
                            var region = currentUser.Region.Trim();
                            estimators = estimators
                                .Where(u => !string.IsNullOrEmpty(u.Region) && 
                                            string.Equals(u.Region.Trim(), region, StringComparison.OrdinalIgnoreCase))
                                .ToList();
                        }
                    }

                    await LoadProjects();
                }
            }
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadProjects()
    {
        if (currentUser == null) return;

        isLoading = true;
        allProjects = await ProjectService.GetProjectsForUser(currentUser);
        
        // Load task counts for all projects (optimization: could be done in service or lazy loaded)
        // For now, we'll fetch all tasks and count in memory to avoid N+1
        // Or better, add a method to ProjectService to get task counts map
        // Let's use existing GetProjectsWithTasks or similar if available, or just iterate for now
        // Given existing service methods, we might need to fetch tasks per project or add a new method.
        // To keep it simple and fast without modifying service yet, we'll assume 0 for now or fetch lazily?
        // Actually, let's try to get counts.
        var allTasksCount = await ProjectService.GetTotalSystemTasksCount(); // Not useful for per project
        
        // We will fetch task counts for visible projects in ApplyFilters or just fetch all tasks once if dataset is small.
        // For now, let's just load projects and filter. Task counts can be 0 until we add a specific efficient method.
        // Re-using GetProjectTasks for each project is expensive.
        // Let's check if we can get a list of all tasks for the user's projects efficiently.
        // I'll skip task counts for the initial load to ensure speed, or implement a bulk fetch later.
        
        // Actually, let's do a quick hack: fetch all tasks if user is admin, or just fetch for displayed projects?
        // Let's leave task counts as 0 for this iteration and focus on the list/filtering.
        
        // Populate filter lists
        availableClients = allProjects.Select(p => p.ProjectClient).Where(c => !string.IsNullOrEmpty(c)).Distinct().OrderBy(c => c).Select(c => c!).ToList();
        availableWorksTypes = allProjects.Select(p => p.ProjectWorkstype).Where(w => !string.IsNullOrEmpty(w)).Distinct().OrderBy(w => w).Select(w => w!).ToList();

        ApplyFilters();
        isLoading = false;
    }

    private void ApplyFilters()
    {
        var query = allProjects.AsEnumerable();

        // Status Filter
        var selectedStatuses = new List<byte>();
        if (showCreated) selectedStatuses.Add(0);
        if (showInProgress) selectedStatuses.Add(1);
        if (showOnHold) selectedStatuses.Add(2);

        if (showReview) selectedStatuses.Add(3);
        if (showCancelled) selectedStatuses.Add(4);
        if (showArchive) selectedStatuses.Add(5); // Assuming 5 is Done/Archive

        // If no status selected, show none? Or show all? Usually show none or default.
        // Let's assume if nothing selected, we show nothing (user needs to select filters).
        // But initially we set InProgress = true.
        
        query = query.Where(p => selectedStatuses.Contains(p.ProjectStatus ?? 0));

        // Search Filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            query = query.Where(p => 
                (p.ProjectName?.ToLower().Contains(term) ?? false) ||
                (p.ProjectWr?.ToLower().Contains(term) ?? false) ||
                (p.ProjectLocation?.ToLower().Contains(term) ?? false) ||
                (p.ProjectDescription?.ToLower().Contains(term) ?? false) ||
                (p.ProjectWo?.ToLower().Contains(term) ?? false) ||
                (p.ProjectPurchaseOrder?.ToLower().Contains(term) ?? false)
            );
        }

        // Estimator Filter
        if (selectedEstimatorId > 0)
        {
            var searchId = selectedEstimatorId.ToString();
            query = query.Where(p => !string.IsNullOrEmpty(p.ProjectUserIds) && 
                                   ("," + p.ProjectUserIds + ",").Contains("," + searchId + ","));
        }



        // Additional Filters
        if (!string.IsNullOrEmpty(selectedClient)) query = query.Where(p => p.ProjectClient == selectedClient);
        if (!string.IsNullOrEmpty(selectedWorksType)) query = query.Where(p => p.ProjectWorkstype == selectedWorksType);
        if (!string.IsNullOrEmpty(searchWo)) query = query.Where(p => p.ProjectWo?.ToLower().Contains(searchWo.ToLower()) ?? false);
        if (!string.IsNullOrEmpty(searchPo)) query = query.Where(p => p.ProjectPurchaseOrder?.ToLower().Contains(searchPo.ToLower()) ?? false);
        if (dateFrom.HasValue) query = query.Where(p => p.ProjectDateCreated >= dateFrom.Value);
        if (dateTo.HasValue) query = query.Where(p => p.ProjectDateCreated <= dateTo.Value.AddDays(1)); // Inclusive

        filteredProjects = query.OrderByDescending(p => p.ProjectDateCreated).ToList();
        
        // Pagination
        totalPages = (int)Math.Ceiling((double)filteredProjects.Count / pageSize);
        if (currentPage > totalPages) currentPage = 1;
        if (currentPage < 1) currentPage = 1;
        
        pagedProjects = filteredProjects
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
            
        // Load task counts for paged projects only
        _ = LoadTaskCountsForPagedProjects();
    }
    
    private async Task LoadTaskCountsForPagedProjects()
    {
        foreach (var project in pagedProjects)
        {
            if (!projectTaskCounts.ContainsKey(project.ProjectId))
            {
                var tasks = await ProjectService.GetProjectTasks(project.ProjectId);
                projectTaskCounts[project.ProjectId] = tasks.Count;
            }
            
            if (!projectEmailCounts.ContainsKey(project.ProjectId))
            {
                projectEmailCounts[project.ProjectId] = await EmailService.GetProjectEmailCount(project.ProjectId);
            }
        }
        await InvokeAsync(StateHasChanged);
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        ApplyFilters(); // Re-slice pagedProjects
    }

    private void ToggleAdvancedSearch()
    {
        showAdvancedSearch = !showAdvancedSearch;
    }

    private string GetStatusText(byte? status)
    {
        return status switch
        {
            0 => "Created",
            1 => "In Progress",
            2 => "On Hold",
            3 => "Review",
            4 => "Cancelled",
            5 => "Done",
            _ => "Unknown"
        };
    }

    private string GetStatusBadgeClass(byte? status)
    {
        return status switch
        {
            0 => "badge-secondary",
            1 => "badge-primary",
            2 => "badge-warning",
            3 => "badge-info",
            4 => "badge-danger",
            5 => "badge-success",
            _ => "badge-dark"
        };
    }

    private string GetWorkstypeBadgeClass(string? workstype)
    {
        if (string.IsNullOrEmpty(workstype)) return "badge-secondary";

        return workstype switch
        {
            "Fee Proposal" => "badge-primary",
            "Delivery" => "badge-success",
            "Indicative" => "badge-info",
            "Quantity Survey" => "badge-warning",
            "Other Works" => "badge-secondary",
            _ => "badge-secondary"
        };
    }

    private string? GetProjectEstimatorName(string? projectUserIds)
    {
        if (string.IsNullOrEmpty(projectUserIds)) return null;

        var userIds = projectUserIds.Split(',', StringSplitOptions.RemoveEmptyEntries);
        foreach (var idStr in userIds)
        {
            if (int.TryParse(idStr, out int id) && estimatorLookup.ContainsKey(id))
            {
                return estimatorLookup[id];
            }
        }
        return null; // No estimator found in the team
    }

    private async Task ConfirmDelete(int projectId, string? projectName)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("Notifications.showConfirm", $"Are you sure you want to delete project: {projectName ?? "Unknown"}? This action cannot be undone.");
        if (confirmed)
        {
            var result = await ProjectService.DeleteProject(projectId);
            if (result.Item1) // Success
            {
                // Refresh list
                await LoadProjects();
                await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", result.Item2 ?? "Project deleted successfully.");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("Notifications.showError", result.Item2 ?? "Failed to delete project.");
            }
        }
    }
}
