@page "/projects/view/{ProjectId:int}"
@using CopelinSystem.Models
@using CopelinSystem.Services
@inject ProjectService ProjectService
@inject ChecklistService ChecklistService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthenticationService AuthService
@inject PermissionService PermissionService
@inject EmailService EmailService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject HtmlExportService HtmlExportService
@inject FileSystemService FileSystemService
@rendermode InteractiveServer

<PageTitle>View Project - Copelin Work Flow Management</PageTitle>

<style>
    .editable-field {
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 3px;
        display: inline-block;
        min-width: 100px;
    }

    .editable-field:hover {
        background-color: #f0f0f0;
    }

    .editable-field.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .editable-field.disabled:hover {
        background-color: transparent;
    }

    .editable-field .fa-edit {
        font-size: 0.8em;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .editable-field:hover .fa-edit {
        opacity: 1;
    }
</style>

<AuthorizeView>
    <Authorized>
        <div class="container-fluid mt-3">
            @if (project == null)
            {
                <div class="text-center">
                    <p>Loading project...</p>
                </div>
            }
            else
            {
                <!-- Header Section -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h3></h3>
                    </div>
                    <div class="col-md-6 text-right">
                        @if (canEdit)
                        {
                            <a href="/projects/edit/@ProjectId" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i> Edit Project</a>
                        }
                        
                        <a href="/projects/prediction/@ProjectId" class="btn btn-sm btn-info ml-2"><i class="fas fa-chart-bar"></i> Prediction</a>

                        @if (canRequestInfo)
                        {
                            <a href="/projects/request-info/@ProjectId" class="btn btn-sm btn-info ml-2"><i class="fas fa-share-square"></i> Request Internal Info</a>
                        }
                        
                        @if (canViewEmails)
                        {
                            <button type="button" class="btn btn-sm btn-info ml-2" @onclick="ScrollToEmails"><i class="fas fa-envelope"></i> Project Emails</button>
                        }
                        
                        @if (canViewFiles)
                        {
                            <a href="/files?projectId=@ProjectId" class="btn btn-sm btn-info ml-2"><i class="fas fa-folder-open"></i> Files</a>
                        }
                        
                        @if (canExportHtml)
                        {
                            <button type="button" class="btn btn-sm btn-info ml-2" @onclick="ExportToHtml"><i class="fas fa-file-code"></i> Export HTML</button>
                        }

                        @if (feeProposalProjectId.HasValue)
                        {
                             <a href="/projects/view/@feeProposalProjectId" target="_blank" class="btn btn-sm btn-info ml-2"><i class="fas fa-file-invoice-dollar"></i> Associated Fee Proposal</a>
                        }
                        
                        <!-- Extra buttons here -->

                       
                    </div>
                </div>



                <!-- Main Project Information Card -->
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h3 class="mb-1"><strong>@project.ProjectLocation - @project.ProjectName</strong></h3>
                                <div class="text-muted small">
                                    Created @project.ProjectDateCreated.ToString("MMMM dd, yyyy") (@((DateTime.Now - project.ProjectDateCreated).Days) days old)
                                </div>
                            </div>
                            <div class="text-right">
                                @if (canEdit)
                                {
                                    <div class="dropdown">
                                        <button class="btn btn-link p-0 text-decoration-none" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="badge @GetStatusBadgeClass(project.ProjectStatus)" style="font-size: 1rem; padding: 0.5rem 0.75rem; cursor: pointer;">
                                                @GetStatusText(project.ProjectStatus) <i class="fas fa-caret-down ml-1"></i>
                                            </span>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right">
                                            <h6 class="dropdown-header">Change Status</h6>
                                            <a class="dropdown-item" href="javascript:void(0)" @onclick="() => UpdateProjectStatus(0)">Created</a>
                                            <a class="dropdown-item" href="javascript:void(0)" @onclick="() => UpdateProjectStatus(1)">In Progress</a>
                                            <a class="dropdown-item" href="javascript:void(0)" @onclick="() => UpdateProjectStatus(2)">On Hold</a>
                                            <a class="dropdown-item" href="javascript:void(0)" @onclick="() => UpdateProjectStatus(3)">Review</a>
                                            <div class="dropdown-divider"></div>
                                            <a class="dropdown-item text-success" href="javascript:void(0)" @onclick="() => UpdateProjectStatus(5)">Done</a>
                                            <a class="dropdown-item text-danger" href="javascript:void(0)" @onclick="() => UpdateProjectStatus(4)">Cancelled</a>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge @GetStatusBadgeClass(project.ProjectStatus)" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                                        @GetStatusText(project.ProjectStatus)
                                    </span>
                                }
                                <div class="text-muted small mt-1">
                                    <strong>Current Ellipse State:</strong>
                                    @if (IsEditing("ProjectEllipesStatus"))
                                    {
                                        <div class="d-flex align-items-center mt-1">
                                            <select class="form-control form-control-sm" @onchange='(e) => SaveField("ProjectEllipesStatus", e.Value?.ToString() ?? "")' style="max-width: 250px;">
                                                <option value="">Select Status...</option>
                                                @foreach (var status in ellipseStatuses)
                                                {
                                                    <option value="@status.FullStatus" selected="@(project.ProjectEllipesStatus == status.FullStatus)">@status.FullStatus</option>
                                                }
                                            </select>
                                            <button class="btn btn-sm btn-link text-danger ml-2" @onclick='() => CancelEdit("ProjectEllipesStatus")'>
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="editable-field" @onclick='() => StartEdit("ProjectEllipesStatus", project.ProjectEllipesStatus ?? "")' title="Click to edit">
                                            @(project.ProjectEllipesStatus ?? "No Ellipse Status") <i class="fas fa-edit ml-2 text-muted"></i>
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row d-flex align-items-start">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                 <table class="table table-sm table-borderless">
                                    <colgroup>
                                        <col style="width: 50%;">
                                        <col style="width: 50%;">
                                    </colgroup>
                                    <tr>
                                        <td><strong>(WR) Work Request Number</strong></td>
                                        <td>
                                            @(project.ProjectWr ?? "-")
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Estimated Completion</strong></td>
                                        <td>@(project.ProjectEndDate?.ToString("MMMM dd, yyyy") ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Client Requested Date</strong></td>
                                        <td>@(project.ProjectClientRequired?.ToString("MMMM dd, yyyy") ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Client Completion Date</strong></td>
                                        <td>@(project.ProjectClientCompletion?.ToString("MMMM dd, yyyy") ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Tender Close Date</strong></td>
                                        <td>@(project.ProjectTendered?.ToString("MMMM dd, yyyy") ?? "-")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Description</strong></td>
                                        <td>
                                            @if (!IsEditing("ProjectDescription"))
                                            {
                                                <span class="editable-field" @onclick="StartEditDescription" title="Click to edit">
                                                    @(project.ProjectDescription ?? "-")
                                                    <i class="fas fa-edit ml-2 text-muted"></i>
                                                </span>
                                            }
                                            else
                                            {
                                                <textarea class="form-control form-control-sm" rows="3"
                                                       @bind="project.ProjectDescription" 
                                                       @onblur="SaveDescription"
                                                       autofocus></textarea>
                                            }
                                            @if (IsSaving("ProjectDescription")) { <i class="fas fa-spinner fa-spin ml-2"></i> }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Client Contact</strong></td>
                                        <td>
                                            @(project.ProjectContact ?? "-")
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Contact Email</strong></td>
                                        <td>
                                            @(project.ProjectContactEmail ?? "-")
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless">
                                    <colgroup>
                                        <col style="width: 50%;">
                                        <col style="width: 50%;">
                                    </colgroup>
                                    <tr>
                                        <td><strong>Work Order</strong></td>
                                        <td>
                                            @if (!IsEditing("ProjectWo"))
                                            {
                                                <span class="editable-field" @onclick='() => StartEdit("ProjectWo", project.ProjectWo ?? "")' title="Click to edit">
                                                    @(project.ProjectWo ?? "-")
                                                    <i class="fas fa-edit ml-2 text-muted"></i>
                                                </span>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control form-control-sm" 
                                                       @bind="project.ProjectWo" 
                                                       @onblur='() => SaveField("ProjectWo", project.ProjectWo ?? "")'
                                                       @onkeydown='(e) => HandleFieldKeyDown(e, "ProjectWo", project.ProjectWo ?? "")'
                                                       autofocus />
                                            }
                                            @if (IsSaving("ProjectWo")) { <i class="fas fa-spinner fa-spin ml-2"></i> }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Quote Tracker Number</strong></td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(project.ProjectQuoteTracker))
                                            {
                                                <a href="@GetQuoteUrl(project.ProjectQuoteTracker)" target="_blank">
                                                    @project.ProjectQuoteTracker <i class="fas fa-external-link-alt small"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                       </tr>
                                    <tr>
                                        <td><strong>Actual Price</strong></td>
                                        <td>$
                                            @if (!IsEditing("ProjectActualPrice"))
                                            {
                                                <span class="editable-field" @onclick='() => StartEdit("ProjectActualPrice", project.ProjectActualPrice ?? "")' title="Click to edit">
                                                    @(project.ProjectActualPrice ?? "-")
                                                    <i class="fas fa-edit ml-2 text-muted"></i>
                                                </span>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control form-control-sm" 
                                                       @bind="project.ProjectActualPrice" 
                                                       @onblur='() => SaveField("ProjectActualPrice", project.ProjectActualPrice ?? "")'
                                                       @onkeydown='(e) => HandleFieldKeyDown(e, "ProjectActualPrice", project.ProjectActualPrice ?? "")'
                                                       autofocus />
                                            }
                                            @if (IsSaving("ProjectActualPrice")) { <i class="fas fa-spinner fa-spin ml-2"></i> }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Indicative Price</strong></td>
                                        <td>$&nbsp;&nbsp;&nbsp;@(project.ProjectIndicative ?? "-")</td>
                                     </tr>
                                    <tr>
                                        <td><strong>Purchase Order</strong></td>
                                        <td>
                                            @if (!IsEditing("ProjectPurchaseOrder"))
                                            {
                                                <span class="editable-field" @onclick='() => StartEdit("ProjectPurchaseOrder", project.ProjectPurchaseOrder ?? "")' title="Click to edit">
                                                    @(project.ProjectPurchaseOrder ?? "-")
                                                    <i class="fas fa-edit ml-2 text-muted"></i>
                                                </span>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control form-control-sm" 
                                                       @bind="project.ProjectPurchaseOrder" 
                                                       @onblur='() => SaveField("ProjectPurchaseOrder", project.ProjectPurchaseOrder ?? "")'
                                                       @onkeydown='(e) => HandleFieldKeyDown(e, "ProjectPurchaseOrder", project.ProjectPurchaseOrder ?? "")'
                                                       autofocus />
                                            }
                                            @if (IsSaving("ProjectPurchaseOrder")) { <i class="fas fa-spinner fa-spin ml-2"></i> }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>IRIS Contract Number</strong></td>
                                        <td>
                                            @if (!IsEditing("ProjectIrisNo"))
                                            {
                                                <span class="editable-field" @onclick='() => StartEdit("ProjectIrisNo", project.ProjectIrisNo ?? "")' title="Click to edit">
                                                    @(project.ProjectIrisNo ?? "-")
                                                    <i class="fas fa-edit ml-2 text-muted"></i>
                                                </span>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control form-control-sm" 
                                                       @bind="project.ProjectIrisNo" 
                                                       @onblur='() => SaveField("ProjectIrisNo", project.ProjectIrisNo ?? "")'
                                                       @onkeydown='(e) => HandleFieldKeyDown(e, "ProjectIrisNo", project.ProjectIrisNo ?? "")'
                                                       autofocus />
                                            }
                                            @if (IsSaving("ProjectIrisNo")) { <i class="fas fa-spinner fa-spin ml-2"></i> }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>eTender Contract Number</strong></td>
                                        <td>
                                            @if (!IsEditing("ProjectEtenderNo"))
                                            {
                                                <span class="editable-field" @onclick='() => StartEdit("ProjectEtenderNo", project.ProjectEtenderNo ?? "")' title="Click to edit">
                                                    @(project.ProjectEtenderNo ?? "-")
                                                    <i class="fas fa-edit ml-2 text-muted"></i>
                                                </span>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control form-control-sm" 
                                                       @bind="project.ProjectEtenderNo" 
                                                       @onblur='() => SaveField("ProjectEtenderNo", project.ProjectEtenderNo ?? "")'
                                                       @onkeydown='(e) => HandleFieldKeyDown(e, "ProjectEtenderNo", project.ProjectEtenderNo ?? "")'
                                                       autofocus />
                                            }
                                            @if (IsSaving("ProjectEtenderNo")) { <i class="fas fa-spinner fa-spin ml-2"></i> }
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Collapsible Button (Full Width) -->
                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#additionalDetails" aria-expanded="false" aria-controls="#additionalDetails">
                                    <i class="fas fa-chevron-down"></i> Show Additional Details
                                </button>
                            </div>
                        </div>
                        
                        <!-- Collapsible Additional Details (Full Width) -->
                        <div class="collapse mt-2" id="additionalDetails">
                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-6">
                                    <table class="table table-sm table-borderless">
                                    <colgroup>
                                        <col style="width: 50%;">
                                        <col style="width: 50%;">
                                    </colgroup>
                                    
                                        <tr>
                                            <td><strong>Consultant</strong></td>
                                            <td>@(project.ProjectConsultant ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Contractor</strong></td>
                                            <td>@(project.ProjectContractor ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>WIC Number</strong></td>
                                            <td>@(project.ProjectWicNo ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Works Type</strong></td>
                                            <td>@(project.ProjectWorkstype ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Program Code</strong></td>
                                            <td>@(project.ProjectProgramCode ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Supervisor</strong></td>
                                            <td>@(project.ProjectSupervisor ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Senior Estimator</strong></td>
                                            <td>@(project.ProjectSeniorEstimator ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Componentisation</strong></td>
                                            <td>@(project.ProjectComponentisation ?? "-")</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- Right Column -->
                                <div class="col-md-6">
                                    <table class="table table-sm table-borderless">
                                    <colgroup>
                                        <col style="width: 50%;">
                                        <col style="width: 50%;">
                                    </colgroup>
                                   
                                        <tr>
                                            <td><strong>Client</strong></td>
                                            <td>@(project.ProjectClient ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>One School Number</strong></td>
                                            <td>@(project.ProjectOneSchool ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Fee Proposal</strong></td>
                                            <td>@(project.ProjectFeeprop ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Req Order Number</strong></td>
                                            <td>@(project.ProjectReqOrder ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Estimators Start Date</strong></td>
                                            <td>@(project.ProjectStartDate?.ToString("MMMM dd, yyyy") ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Location</strong></td>
                                            <td>@(project.ProjectLocation ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Region</strong></td>
                                            <td>@(project.ProjectRegion ?? "-")</td>
                                        </tr>

                                    </table>
                                </div>
                            </div>
                        </div>


                        <!-- Project Info Section -->
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label><strong>Project Hours</strong></label>
                                <p>@projectHours hrs</p>
                            </div>
                            <div class="col-md-4">
                                <label><strong>Project Progress</strong></label>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 mr-2" style="height: 10px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: @(projectProgress.ToString("0"))%;" aria-valuenow="@(projectProgress.ToString("0"))" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <span class="font-weight-bold">@projectProgress.ToString("0")%</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label><strong>Estimator</strong></label>
                                <p>
                                    @if (assignedUserNames.Any())
                                    {
                                        @string.Join(", ", assignedUserNames)
                                    }
                                    else
                                    {
                                        @(project.ProjectSeniorEstimator ?? "Not assigned")
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task List Section -->
                @if (canViewTasks)
                {
                    <div class="card mt-3 card-outline card-info">
                        <div class="card-header">
                            <h3 class="card-title">Task List:</h3>
                            <div class="card-tools">
                                @if (canAddTasks)
                                {
                                    <button class="btn btn-sm btn-primary" @onclick="() => OpenTaskModal()"><i class="fas fa-plus"></i> New Task</button>
                                }
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table m-0">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Date</th>
                                            <th>Task</th>
                                            <th>Description</th>
                                            <th>Days</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (tasks == null || !tasks.Any())
                                        {
                                            <tr>
                                                <td colspan="7" class="text-center">No tasks found.</td>
                                            </tr>
                                        }
                                        else
                                        {
                                            int index = 1;
                                            foreach (var task in tasks)
                                            {
                                                <tr>
                                                    <td>@index</td>
                                                    <td>@task.DateCreated.ToString("dd-MM-yyyy")</td>
                                                    <td>@task.Task</td>
                                                    <td>
                                                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                                             title="@task.Description">
                                                            @task.Description
                                                        </div>
                                                    </td>
                                                    <td>@(task.EstimatedDays?.ToString() ?? "-")</td>
                                                    <td>
                                                        @if (task.Status == 0)
                                                        {
                                                            <span class="badge badge-warning">Pending</span>
                                                        }
                                                        else if (task.Status == 1)
                                                        {
                                                            <span class="badge badge-primary">In-Progress</span>
                                                        }
                                                        else if (task.Status == 3)
                                                        {
                                                            <span class="badge badge-success">Done</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge badge-secondary">Unknown</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <button class="btn btn-sm btn-info dropdown-toggle" data-toggle="dropdown">Action</button>
                                                            <div class="dropdown-menu">
                                                                <a class="dropdown-item" href="javascript:void(0)" @onclick="() => ViewTask(task)">View</a>
                                                                @{
                                                                    var hasProductivity = productivity?.Any(p => p.ProductivityTaskId == task.TaskId) ?? false;
                                                                }
                                                                @if (canEditTasks)
                                                                {
                                                                    <a class="dropdown-item" href="javascript:void(0)" @onclick="() => OpenTaskModal(task)">Edit</a>
                                                                }
                                                                @if (canDeleteTasks)
                                                                {
                                                                    @if (hasProductivity)
                                                                    {
                                                                        <a class="dropdown-item disabled text-muted" href="javascript:void(0)" style="cursor: not-allowed;" title="Cannot delete task with productivity entries">Delete</a>
                                                                    }
                                                                    else
                                                                    {
                                                                        <a class="dropdown-item" href="javascript:void(0)" @onclick="() => DeleteTask(task.TaskId)">Delete</a>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                index++;
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }

                <!-- Productivity/Comments Section -->
                @if (canViewProductivity)
                {
                    <div class="card mt-3 card-outline card-warning">
                        <div class="card-header">
                            <h3 class="card-title">Estimator Productivity / Comments</h3>
                            <div class="card-tools">
                                @if (canAddProductivity)
                                {
                                    <button class="btn btn-sm btn-primary" @onclick="() => OpenProductivityModal()"><i class="fas fa-plus"></i> New Productivity</button>
                                }
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table m-0">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>User</th>
                                            <th>Task</th>
                                            <th>Comment</th>
                                            <th>Hours</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (productivity == null || !productivity.Any())
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center">No productivity entries found.</td>
                                            </tr>
                                        }
                                        else
                                        {
                                            foreach (var entry in productivity)
                                            {
                                                <tr>
                                                    <td>@entry.ProductivityDate?.ToString("dd-MM-yyyy")</td>
                                                    <td>@(userNames.ContainsKey(entry.ProductivityUserId ?? 0) ? userNames[entry.ProductivityUserId ?? 0] : "Unknown")</td>
                                                    <td>@(taskNames.ContainsKey(entry.ProductivityTaskId ?? 0) ? taskNames[entry.ProductivityTaskId ?? 0] : "-")</td>
                                                    <td>
                                                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                                             title="@entry.ProductivityComment">
                                                            @entry.ProductivityComment
                                                        </div>
                                                    </td>
                                                    <td>@(entry.ProductivityTimeRendered?.ToString("0.00") ?? "0.00")</td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <button class="btn btn-sm btn-info dropdown-toggle" data-toggle="dropdown">Action</button>
                                                            <div class="dropdown-menu">
                                                                <a class="dropdown-item" href="javascript:void(0)" @onclick="() => ViewProductivity(entry)">View</a>
                                                                @if (canEditProductivity)
                                                                {
                                                                    <a class="dropdown-item" href="javascript:void(0)" @onclick="() => OpenProductivityModal(entry)">Edit</a>
                                                                }
                                                                @if (canDeleteProductivity)
                                                                {
                                                                    <a class="dropdown-item" href="javascript:void(0)" @onclick="() => DeleteProductivity(entry.ProductivityId)">Delete</a>
                                                                }
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }

                <!-- ISO Forms / Checklists Section -->
                <div class="card mt-3 card-outline card-indigo">
                    <div class="card-header">
                        <h3 class="card-title">ISO Forms / Checklists</h3>
                        <div class="card-tools">
                            <button class="btn btn-sm btn-primary" @onclick="OpenStartChecklistModal"><i class="fas fa-plus"></i> Start New</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table m-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th style="min-width: 100px;">Status</th>
                                        <th style="min-width: 120px;">Progress</th>
                                        <th style="min-width: 130px;">Created</th>
                                        <th style="min-width: 130px;">Updated</th>
                                        <th style="min-width: 110px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (projectChecklists == null)
                                    {
                                        <tr><td colspan="6" class="text-center">Loading...</td></tr>
                                    }
                                    else if (!projectChecklists.Any())
                                    {
                                        <tr><td colspan="6" class="text-center">No checklists started for this project.</td></tr>
                                    }
                                    else
                                    {
                                        foreach (var pc in projectChecklists)
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@(pc.Template?.Name ?? "Unknown Template")</strong>

                                                </td>
                                                <td>
                                                    @if (pc.Status == "Completed")
                                                    {
                                                        <span class="badge badge-success">Completed</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-warning">In Progress</span>
                                                    }
                                                </td>
                                                <td>
                                                     <div class="progress progress-xs">
                                                        @{
                                                            var progress = pc.Status == "Completed" ? 100 : 50; 
                                                        }
                                                        <div class="progress-bar bg-primary" style="width: @progress%"></div>
                                                    </div>
                                                    <small>@progress%</small>
                                                </td>
                                                <td>
                                                    @pc.CreatedDate.ToString("dd-MM-yyyy")<br/>
                                                    <small class="text-muted">by @pc.CreatedBy</small>
                                                </td>
                                                <td>
                                                    @(pc.CompletedDate?.ToString("dd-MM-yyyy") ?? "-")
                                                </td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                                            Action
                                                        </button>
                                                        <div class="dropdown-menu">
                                                            <a class="dropdown-item" href="/iso-forms/run/@pc.ChecklistInstanceId">View / Edit</a>
                                                             <a class="dropdown-item" href="javascript:void(0)" @onclick="() => SaveChecklistToFiles(pc)">Save to Files</a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <!-- New Checklist Modal -->
                @if (showStartChecklistModal)
                {
                    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Start New Checklist</h5>
                                    <button type="button" class="close" @onclick="CloseStartChecklistModal">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label>Select Template</label>
                                        <select class="form-control" @bind="selectedTemplateId">
                                            <option value="0">-- Select Template --</option>
                                            @if (availableTemplates != null)
                                            {
                                                foreach (var t in availableTemplates)
                                                {
                                                    var isStarted = projectChecklists?.Any(pc => pc.TemplateId == t.TemplateId) ?? false;
                                                    <option value="@t.TemplateId" disabled="@isStarted">
                                                        @t.Name (v@(t.Version)) @(isStarted ? " (Started/Complete)" : "")
                                                    </option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseStartChecklistModal">Cancel</button>
                                    <button type="button" class="btn btn-primary" @onclick="StartChecklist" disabled="@(selectedTemplateId == 0)">Start</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }


                <!-- Email Section -->
                @if (canViewEmails)
                {
                    <div class="card mt-3 card-outline card-success" id="project-emails">
                        <div class="card-header">
                            <h3 class="card-title">Project Emails</h3>
                            <div class="card-tools">
                                <span class="badge badge-info">@emailCount emails</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table m-0">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>From</th>
                                            <th>Subject</th>
                                            <th>WR Number</th>
                                            <th>Attachments</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (emails == null || !emails.Any())
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center">No emails found for this project.</td>
                                            </tr>
                                        }
                                        else
                                        {
                                            foreach (var email in emails)
                                            {
                                                <tr>
                                                    <td>@email.ReceivedDate.ToString("dd-MM-yyyy HH:mm")</td>
                                                    <td>
                                                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                                             title="@email.EmailFrom">
                                                            @email.EmailFrom
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                                             title="@email.EmailSubject">
                                                            @email.EmailSubject
                                                        </div>
                                                    </td>
                                                    <td>
                                                        @if (email.IsMatched)
                                                        {
                                                            <span class="badge badge-success" title="Matched to project">@email.ProjectWr</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge badge-warning" title="Not matched to project">@(email.ProjectWr ?? "None")</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (emailAttachments.ContainsKey(email.EmailId) && emailAttachments[email.EmailId].Any())
                                                        {
                                                            <span class="badge badge-info" title="@emailAttachments[email.EmailId].Count attachment(s)">
                                                                <i class="fas fa-paperclip"></i> @emailAttachments[email.EmailId].Count
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info" @onclick="() => ViewEmail(email)">
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h3>Please log in to view projects.</h3>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectList? project;
    private List<TaskList>? tasks;
    private List<UserProductivity>? productivity;
    private Dictionary<int, string> taskNames = new();
    private Dictionary<int, string> userNames = new();
    private decimal projectProgress = 0;

    private decimal projectHours = 0;
    private List<StatusCode> ellipseStatuses = new();
    private int? feeProposalProjectId = null;
    private List<string> debugMatches = new();

    // Inline editing state
    private Dictionary<string, bool> editingFields = new();
    private Dictionary<string, string> originalValues = new();
    private Dictionary<string, bool> savingFields = new();
    private User? currentUser;
    private bool canEditWr = false;
    private bool canEdit = false;
    
    // Granular permissions
    private bool canViewTasks = false;
    private bool canAddTasks = false;
    private bool canEditTasks = false;
    private bool canDeleteTasks = false;
    
    private bool canViewProductivity = false;
    private bool canAddProductivity = false;
    private bool canEditProductivity = false;
    private bool canDeleteProductivity = false;

    // Email permissions and state
    private bool canViewEmails = false;
    private List<ProjectEmail>? emails;
    private Dictionary<int, List<ProjectEmailAttachment>> emailAttachments = new();
    private int emailCount = 0;
    private ProjectEmail? selectedEmail = null;
    private bool showEmailModal = false;

    private List<string> assignedUserNames = new();

    // Request Info Permission
    private bool canRequestInfo = false;
    
    // New Permissions
    private bool canViewFiles = false;
    private bool canExportHtml = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        // Load Ellipse Statuses
        ellipseStatuses = await ProjectService.GetEllipseStatuses();

        // Check for Associated Fee Proposal
        if (project != null && !string.IsNullOrEmpty(project.ProjectFeeprop))
        {
            var feeProject = await ProjectService.GetProjectByWr(project.ProjectFeeprop.Trim());
            if (feeProject != null)
            {
                feeProposalProjectId = feeProject.ProjectId;
            }
            else
            {
                // DEBUG: Fetch matches
                debugMatches = await ProjectService.GetDebugProjectMatches(project.ProjectFeeprop.Trim());
            }
        }

        if (user.Identity?.IsAuthenticated == true)
        {
            // Get current user for role checking
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUser = await AuthService.GetUserById(userId);
                if (currentUser != null)
                {
                    // Use permission system instead of hardcoded role checks
                    canEditWr = await PermissionService.UserHasPermission(currentUser, "EditProjects");
                    canEdit = await PermissionService.UserHasPermission(currentUser, "EditProjects");
                    
                    // Task permissions
                    canViewTasks = await PermissionService.UserHasPermission(currentUser, "ViewTasks");
                    canAddTasks = await PermissionService.UserHasPermission(currentUser, "AddTasks");
                    canEditTasks = await PermissionService.UserHasPermission(currentUser, "EditTasks");
                    canDeleteTasks = await PermissionService.UserHasPermission(currentUser, "DeleteTasks");
                    
                    // Productivity permissions
                    canViewProductivity = await PermissionService.UserHasPermission(currentUser, "ViewProductivity");
                    canAddProductivity = await PermissionService.UserHasPermission(currentUser, "AddProductivity");
                    canEditProductivity = await PermissionService.UserHasPermission(currentUser, "EditProductivity");
                    canDeleteProductivity = await PermissionService.UserHasPermission(currentUser, "DeleteProductivity");
                    
                    // Email permissions
                    canViewEmails = await PermissionService.UserHasPermission(currentUser, "ViewEmails");

                    // Request Info permission
                    // Request Info permission
                    canRequestInfo = await PermissionService.UserHasPermission(currentUser, "RequestExternalInfo");
                    
                    // View Files & Export permissions
                    canViewFiles = await PermissionService.UserHasPermission(currentUser, "ViewProjectFiles");
                    canExportHtml = await PermissionService.UserHasPermission(currentUser, "ExportProjectHtml");
                }
            }

            // Load project
            project = await ProjectService.GetProjectById(ProjectId);

            if (project != null)
            {
                // Load tasks
                tasks = await ProjectService.GetProjectTasks(ProjectId);

                // Build task names dictionary
                if (tasks != null)
                {
                    foreach (var task in tasks)
                    {
                        taskNames[task.TaskId] = task.Task ?? "Unnamed Task";
                    }
                }

                // Load productivity
                productivity = await ProjectService.GetProjectProductivity(ProjectId);

                // Build user names dictionary
                if (productivity != null)
                {
                    var userIds = productivity.Select(p => p.ProductivityUserId ?? 0).Distinct().Where(id => id > 0);
                    foreach (var id in userIds)
                    {
                        var userData = await ProjectService.GetUserById(id);
                        if (userData != null)
                        {
                            userNames[id] = userData.DisplayName;
                        }
                        else
                        {
                            // User not found in database - show ID for debugging
                            userNames[id] = $"User ID: {id}";
                        }
                    }
                }

                // Load project progress and hours
                projectProgress = await ProjectService.GetProjectProgress(ProjectId);
                projectHours = await ProjectService.GetProjectTotalHours(ProjectId);

                // Load assigned users
                if (!string.IsNullOrEmpty(project.ProjectUserIds))
                {
                    var assignedIds = project.ProjectUserIds.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                                          .Select(id => int.TryParse(id, out int parsedId) ? parsedId : 0)
                                                          .Where(id => id > 0);
                    
                    foreach (var id in assignedIds)
                    {
                        var userData = await ProjectService.GetUserById(id);
                        if (userData != null)
                        {
                            assignedUserNames.Add(userData.DisplayName);
                        }
                    }
                }

                // Load emails
                if (canViewEmails)
                {
                    emails = await EmailService.GetProjectEmails(ProjectId);
                    emailCount = emails?.Count ?? 0;
                    
                    // Load attachments for each email
                    if (emails != null)
                    {
                        foreach (var email in emails)
                        {
                            var attachments = await EmailService.GetEmailAttachments(email.EmailId);
                            emailAttachments[email.EmailId] = attachments;
                        }
                    }
                }
                
                await LoadChecklists();
            }
            else
            {
                // Project not found, redirect to home
                Navigation.NavigateTo("/");
            }
        }
    }

    private string GetStatusText(byte? status)
    {
        return status switch
        {
            0 => "Created",
            1 => "In Progress",
            2 => "On Hold",
            3 => "Review",
            4 => "Cancelled",
            5 => "Done",
            _ => "Unknown"
        };
    }

    private string GetStatusBadgeClass(byte? status)
    {
        return status switch
        {
            0 => "badge-secondary",      // Created - Gray
            1 => "badge-primary",        // In Progress - Blue
            2 => "badge-warning",        // On Hold - Yellow/Orange
            3 => "badge-info",           // Review - Light Blue
            4 => "badge-danger",         // Cancelled - Red
            5 => "badge-success",        // Done - Green
            _ => "badge-dark"            // Unknown - Dark
        };
    }

    // Inline Editing Methods
    private void StartEdit(string fieldName, string currentValue)
    {
        editingFields[fieldName] = true;
        originalValues[fieldName] = currentValue ?? "";
    }

    private void CancelEdit(string fieldName)
    {
        editingFields[fieldName] = false;
        originalValues.Remove(fieldName);
    }

    private async Task SaveField(string fieldName, string newValue)
    {
        if (project == null) return;

        savingFields[fieldName] = true;
        StateHasChanged();

        try
        {
            // Update the project field based on fieldName
            switch (fieldName)
            {
                case "ProjectName":
                    project.ProjectName = newValue;
                    break;
                case "ProjectWr":
                    if (canEditWr) project.ProjectWr = newValue;
                    break;
                case "ProjectDescription":
                    project.ProjectDescription = newValue;
                    break;
                case "ProjectLocation":
                    project.ProjectLocation = newValue;
                    break;
                case "ProjectWo":
                    project.ProjectWo = newValue;
                    break;
                case "ProjectQuoteTracker":
                    project.ProjectQuoteTracker = newValue;
                    break;
                case "ProjectSupervisor":
                    project.ProjectSupervisor = newValue;
                    break;
                case "ProjectSeniorEstimator":
                    project.ProjectSeniorEstimator = newValue;
                    break;
                case "ProjectRegion":
                    project.ProjectRegion = newValue;
                    break;
                case "ProjectClient":
                    project.ProjectClient = newValue;
                    break;
                case "ProjectConsultant":
                    project.ProjectConsultant = newValue;
                    break;
                case "ProjectContractor":
                    project.ProjectContractor = newValue;
                    break;
                case "ProjectComponentisation":
                    project.ProjectComponentisation = newValue;
                    break;
                case "ProjectFeeprop":
                    project.ProjectFeeprop = newValue;
                    break;
                case "ProjectReqOrder":
                    project.ProjectReqOrder = newValue;
                    break;
                case "ProjectEllipesStatus":
                    project.ProjectEllipesStatus = newValue;
                    break;
                case "ProjectOneSchool":
                    project.ProjectOneSchool = newValue;
                    break;
                case "ProjectFolderPath":
                    project.ProjectFolderPath = newValue;
                    break;

                case "ProjectActualPrice":
                    project.ProjectActualPrice = newValue;
                    break;
                case "ProjectPurchaseOrder":
                    project.ProjectPurchaseOrder = newValue;
                    break;
                case "ProjectIrisNo":
                    project.ProjectIrisNo = newValue;
                    break;
                case "ProjectEtenderNo":
                    project.ProjectEtenderNo = newValue;
                    break;
            }

            // Save to database
            await ProjectService.UpdateProject(project);

            // Clear editing state
            editingFields[fieldName] = false;
            originalValues.Remove(fieldName);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", $"Error saving field: {ex.Message}");
        }
        finally
        {
            savingFields[fieldName] = false;
            StateHasChanged();
        }
    }

    private async Task SaveDateField(string fieldName, DateTime? newValue)
    {
        if (project == null) return;

        savingFields[fieldName] = true;
        StateHasChanged();

        try
        {
            switch (fieldName)
            {
                case "ProjectEndDate":
                    project.ProjectEndDate = newValue;
                    break;
                case "ProjectStartDate":
                    project.ProjectStartDate = newValue;
                    break;
                case "ProjectClientRequired":
                    project.ProjectClientRequired = newValue;
                    break;
                case "ProjectClientCompletion":
                    project.ProjectClientCompletion = newValue;
                    break;
            }

            await ProjectService.UpdateProject(project);
            editingFields[fieldName] = false;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", $"Error saving date: {ex.Message}");
        }
        finally
        {
            savingFields[fieldName] = false;
            StateHasChanged();
        }
    }

    private async Task HandleFieldKeyDown(KeyboardEventArgs e, string fieldName, string value)
    {
        if (e.Key == "Enter")
        {
            await SaveField(fieldName, value);
        }
        else if (e.Key == "Escape")
        {
            CancelEdit(fieldName);
        }
    }

    private void StartEditWr() { if (canEditWr) StartEdit("ProjectWr", project?.ProjectWr ?? ""); }
    private async Task HandleWrKeyDown(KeyboardEventArgs e) => await HandleFieldKeyDown(e, "ProjectWr", project?.ProjectWr ?? "");

    private void StartEditDescription() => StartEdit("ProjectDescription", project?.ProjectDescription ?? "");

    private async Task SaveWr() => await SaveField("ProjectWr", project?.ProjectWr ?? "");
    private async Task SaveDescription() => await SaveField("ProjectDescription", project?.ProjectDescription ?? "");

    private bool IsEditing(string fieldName) => editingFields.ContainsKey(fieldName) && editingFields[fieldName];
    private bool IsSaving(string fieldName) => savingFields.ContainsKey(fieldName) && savingFields[fieldName];

    // Modal Logic
    private bool showTaskModal = false;
    private bool showProductivityModal = false;
    private TaskList currentTask = new();
    private UserProductivity currentProductivity = new();
    private DateTime? bindStartTime;
    private DateTime? bindEndTime;
    private bool isEditingTask = false;
    private bool isEditingProductivity = false;

    private List<string> predefinedTasks = new List<string>
    {
        "Project Files & Documentation",
        "Fee Proposal & Costing",
        "Document Preperation",
        "Project Scoping",
        "Tender Management",
        "Exception Management",
        "Estimating Evaluation",
        "Quote Issued",
        "Quote Approved",
        "Quote Received",
        "Handover & Closeout",
        "--------------------------------",
        "PQC",
        "Financial Capacity Check",
        "Design",
        "RFI",
        "Administration",
        "WO/WR/REQ/SWQ etc",
        "PEP/COI/Score Sheet etc",
        "Addendum",
        "Componentisation",
        "Awaiting Scoping",
        "Corrospondence",
        "BAC Application",
        "Planning Approval",
        "Capital Services (eTender)",
        "POA",
        "Financial Approvals",
        "Re-Tender",
        "Variation",
        "Delayed",
        "Deferred",
        "Cancelled"
    };

    // Task Modal Methods
    private void OpenTaskModal(TaskList? task = null)
    {
        if (task != null)
        {
            isEditingTask = true;
            currentTask = new TaskList
            {
                TaskId = task.TaskId,
                TaskProjectId = task.TaskProjectId,
                Task = task.Task,
                Description = task.Description,
                Status = task.Status,
                DateCreated = task.DateCreated,
                DateEnded = task.DateEnded,
                EstimatedDays = task.EstimatedDays,
                Progress = task.Progress,
                Dependencies = task.Dependencies
            };
        }
        else
        {
            isEditingTask = false;
            currentTask = new TaskList
            {
                TaskProjectId = ProjectId,
                DateCreated = DateTime.Now,
                Status = 0 // Pending
            };
        }
        showTaskModal = true;
    }

    private void CloseTaskModal()
    {
        showTaskModal = false;
    }

    private async Task SaveTask(bool createProductivity = false)
    {
        int newTaskId = 0;
        
        if (isEditingTask)
        {
            await ProjectService.UpdateProjectTask(currentTask);
            newTaskId = currentTask.TaskId;
        }
        else
        {
            await ProjectService.AddProjectTask(currentTask);
            // Get the newly created task ID by refreshing and finding it
            var tempTasks = await ProjectService.GetProjectTasks(ProjectId);
            var newTask = tempTasks?.OrderByDescending(t => t.TaskId).FirstOrDefault();
            if (newTask != null)
            {
                newTaskId = newTask.TaskId;
            }
        }

        // Refresh tasks
        tasks = await ProjectService.GetProjectTasks(ProjectId);
        // Update task names dictionary
        if (tasks != null)
        {
            taskNames.Clear();
            foreach (var task in tasks)
            {
                taskNames[task.TaskId] = task.Task ?? "Unnamed Task";
            }
        }
        
        // Update progress
        projectProgress = await ProjectService.GetProjectProgress(ProjectId);

        // Auto-update project status to "In Progress" if it's currently "Created"
        if (project != null && project.ProjectStatus == 0)
        {
            await UpdateProjectStatus(1); // Set to In Progress
        }

        CloseTaskModal();
        
        // If createProductivity is true, open the productivity modal with the new task pre-selected
        if (createProductivity && newTaskId > 0)
        {
            await OpenProductivityModalWithTask(newTaskId);
        }
    }
    
    private async Task OpenProductivityModalWithTask(int taskId)
    {
        // Get current user ID
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst("UserId");
        int userId = 0;
        if (userIdClaim != null && int.TryParse(userIdClaim.Value, out userId))
        {
            // use retrieved userId
        }
        else
        {
            // fallback or handle missing claim
            userId = 0; // or appropriate default
        }

        isEditingProductivity = false;
        currentProductivity = new UserProductivity
        {
            ProductivityProjectId = ProjectId,
            ProductivityDate = DateTime.Now,
            ProductivityUserId = userId,
            ProductivityTaskId = taskId
        };
        bindStartTime = null;
        bindEndTime = null;
        showProductivityModal = true;
    }

    private async Task CopyPathToClipboard(string path)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", path);
            await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", $"Path copied to clipboard:\n{path}");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", $"Unable to copy to clipboard. Path:\n{path}");
        }
    }

    private async Task UpdateProjectStatus(byte newStatus)
    {
        if (project != null)
        {
            // Validation: Cannot set Project to Done (5) unless all tasks are Done (3)
            if (newStatus == 5)
            {
                if (tasks != null && tasks.Any(t => t.Status != 3))
                {
                    await JSRuntime.InvokeVoidAsync("Notifications.showError", "Cannot mark project as 'Done' because there are open tasks. Please complete all tasks first.");
                    return;
                }
            }

            // Start Date Logic: If moving from Created (0) to In Progress (1), set Start Date
            if (project.ProjectStatus == 0 && newStatus == 1)
            {
                project.ProjectStartDate = DateTime.Now;
            }

            project.ProjectStatus = newStatus;
            await ProjectService.UpdateProject(project);
            StateHasChanged();
        }
    }

    private async Task DeleteTask(int taskId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("Notifications.showConfirm", "Are you sure you wish to delete this task?");
        if (confirmed)
        {
            if (await ProjectService.DeleteProjectTask(taskId))
            {
                tasks = await ProjectService.GetProjectTasks(ProjectId);
                projectProgress = await ProjectService.GetProjectProgress(ProjectId);
                await CheckAndRevertStatus();
                await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", "Task deleted successfully.");
            }
            else
            {
                 await JSRuntime.InvokeVoidAsync("Notifications.showError", "Failed to delete task.");
            }
        }
    }

    private async Task DeleteProductivity(int productivityId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("Notifications.showConfirm", "Are you sure you wish to delete this productivity entry?");
        if (confirmed)
        {
            if (await ProjectService.DeleteUserProductivity(productivityId))
            {
                productivity = await ProjectService.GetProjectProductivity(ProjectId);
                projectHours = await ProjectService.GetProjectTotalHours(ProjectId);
                await CheckAndRevertStatus();
                await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", "Productivity entry deleted successfully.");
            }
            else
            {
                 await JSRuntime.InvokeVoidAsync("Notifications.showError", "Failed to delete productivity entry.");
            }
        }
    }

    private async Task CheckAndRevertStatus()
    {
        // If no tasks and no productivity, revert to Created
        if ((tasks == null || !tasks.Any()) && (productivity == null || !productivity.Any()))
        {
            if (project != null && project.ProjectStatus != 0)
            {
                await UpdateProjectStatus(0); // Revert to Created
            }
        }
    }

    // Productivity Modal Methods
    private async Task OpenProductivityModal(UserProductivity? prod = null)
    {
        if (prod == null && (tasks == null || !tasks.Any()))
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", "You cannot add productivity/progress until a task has been created.");
            return;
        }

        if (prod != null)
        {
            isEditingProductivity = true;
            currentProductivity = new UserProductivity
            {
                ProductivityId = prod.ProductivityId,
                ProductivityProjectId = prod.ProductivityProjectId,
                ProductivityTaskId = prod.ProductivityTaskId,
                ProductivitySubject = prod.ProductivitySubject,
                ProductivityComment = prod.ProductivityComment,
                ProductivityDate = prod.ProductivityDate,
                ProductivityStartTime = prod.ProductivityStartTime,
                ProductivityEndTime = prod.ProductivityEndTime,
                ProductivityUserId = prod.ProductivityUserId,
                ProductivityTimeRendered = prod.ProductivityTimeRendered,
                ProductivityDateCreated = prod.ProductivityDateCreated
            };
            // Map TimeSpan to DateTime for binding
            if (prod.ProductivityStartTime.HasValue)
                bindStartTime = DateTime.Today.Add(prod.ProductivityStartTime.Value);
            else
                bindStartTime = null;

            if (prod.ProductivityEndTime.HasValue)
                bindEndTime = DateTime.Today.Add(prod.ProductivityEndTime.Value);
            else
                bindEndTime = null;
        }
        else
        {
            isEditingProductivity = false;
            // Get current user ID
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst("UserId");
            int userId = 0;
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out userId))
            {
                // use retrieved userId
            }
            else
            {
                // fallback or handle missing claim
                userId = 0; // or appropriate default
            }

            currentProductivity = new UserProductivity
            {
                ProductivityProjectId = ProjectId,
                ProductivityDate = DateTime.Now,
                ProductivityUserId = userId
            };
            bindStartTime = null;
            bindEndTime = null;
        }
        showProductivityModal = true;
    }

    private void CloseProductivityModal()
    {
        showProductivityModal = false;
        currentProductivity = new UserProductivity();
    }

    // View Modal Logic
    private bool showViewTaskModal = false;
    private bool showViewProductivityModal = false;

    private void ViewTask(TaskList task)
    {
        currentTask = task;
        showViewTaskModal = true;
    }

    private void CloseViewTaskModal()
    {
        showViewTaskModal = false;
        // Don't reset currentTask here as it might be used by the view
    }

    private void ViewProductivity(UserProductivity entry)
    {
        currentProductivity = entry;
        showViewProductivityModal = true;
    }

    private void CloseViewProductivityModal()
    {
        showViewProductivityModal = false;
        // Don't reset currentProductivity here
    }



    private async Task SaveProductivity()
    {
        // Map DateTime back to TimeSpan
        if (bindStartTime.HasValue)
            currentProductivity.ProductivityStartTime = bindStartTime.Value.TimeOfDay;
        else
            currentProductivity.ProductivityStartTime = null;

        if (bindEndTime.HasValue)
            currentProductivity.ProductivityEndTime = bindEndTime.Value.TimeOfDay;
        else
            currentProductivity.ProductivityEndTime = null;

        // Calculate hours if start/end times are set
        if (currentProductivity.ProductivityStartTime.HasValue && currentProductivity.ProductivityEndTime.HasValue)
        {
            var duration = currentProductivity.ProductivityEndTime.Value - currentProductivity.ProductivityStartTime.Value;
            currentProductivity.ProductivityTimeRendered = (float)duration.TotalHours;
        }
        else
        {
            currentProductivity.ProductivityTimeRendered = null;
        }

        // Ensure the productivity entry is linked to the current project
        currentProductivity.ProductivityProjectId = ProjectId;

        // Set the user ID based on the authenticated user
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst("UserId");
        if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
        {
            currentProductivity.ProductivityUserId = userId;
        }

        if (isEditingProductivity)
        {
            await ProjectService.UpdateUserProductivity(currentProductivity);
        }
        else
        {
            await ProjectService.AddUserProductivity(currentProductivity);
        }

        // Refresh productivity and project hours
        productivity = await ProjectService.GetProjectProductivity(ProjectId);
        projectHours = await ProjectService.GetProjectTotalHours(ProjectId);

        // Update userNames dictionary for the newly added/updated user
        if (currentProductivity.ProductivityUserId.HasValue && currentProductivity.ProductivityUserId.Value > 0)
        {
            var newUserId = currentProductivity.ProductivityUserId.Value;
            if (!userNames.ContainsKey(newUserId))
            {
                var userData = await ProjectService.GetUserById(newUserId);
                if (userData != null)
                {
                    userNames[newUserId] = userData.DisplayName;
                }
                else
                {
                    userNames[newUserId] = $"User ID: {newUserId}";
                }
            }
        }

        CloseProductivityModal();
    }

    private async Task ExportToHtml()
    {
        if (project == null || tasks == null || productivity == null) return;

        try
        {
            var html = HtmlExportService.ExportProjectToHtml(project, tasks, productivity, userNames, taskNames, projectChecklists);
            var filename = $"Project_{project.ProjectWr ?? project.ProjectId.ToString()}_{project.ProjectName}.html";
            
            // Remove invalid filename characters
            foreach (char c in System.IO.Path.GetInvalidFileNameChars())
            {
                filename = filename.Replace(c, '_');
            }

            await JSRuntime.InvokeVoidAsync("downloadFile", filename, html);
            await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", "HTML Export downloaded successfully.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", $"Error exporting to HTML: {ex.Message}");
        }
    }
    }



@if (showTaskModal)
{
    <div class="modal fade show" style="display: block; padding-right: 17px;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">@(isEditingTask ? "Edit Task" : "New Task") For @project?.ProjectName</h4>
                    <button type="button" class="close" @onclick="CloseTaskModal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Task</label>
                        <div class="input-group">
                            <input type="text" class="form-control" @bind="currentTask.Task" placeholder="Enter task name" list="predefinedTasksList" />
                            <datalist id="predefinedTasksList">
                                @foreach (var taskName in predefinedTasks)
                                {
                                    <option value="@taskName"></option>
                                }
                            </datalist>
                            <div class="input-group-append">
                                
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" rows="5" @bind="currentTask.Description" placeholder="Keep brief, expand in productivity notes!"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-control" @bind="currentTask.DateCreated" lang="en-AU" />
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" @bind="currentTask.Status">
                            <option value="0">Pending</option>
                            <option value="1">In-Progress</option>
                            <option value="3">Done</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" @onclick="CloseTaskModal">Cancel</button>
                    <div>
                        <button type="button" class="btn btn-primary" @onclick="() => SaveTask(false)">Save</button>
                        <button type="button" class="btn btn-success ml-2" @onclick="() => SaveTask(true)">
                            <i class="fas fa-plus-circle"></i> Save & Create Productivity
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showProductivityModal)
{
    <div class="modal fade show" style="display: block; padding-right: 17px;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">@(isEditingProductivity ? "Edit Progress" : "New Progress") @project?.ProjectName</h4>
                    <button type="button" class="close" @onclick="CloseProductivityModal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Project Task</label>
                                <select class="form-control" @bind="currentProductivity.ProductivityTaskId">
                                    <option value="">Please select here</option>
                                    @if (tasks != null)
                                    {
                                        foreach (var task in tasks)
                                        {
                                            <option value="@task.TaskId">@task.Task</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Subject</label>
                                <input type="text" class="form-control" @bind="currentProductivity.ProductivitySubject" />
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" class="form-control" @bind="currentProductivity.ProductivityDate" lang="en-AU" />
                            </div>
                            <div class="form-group">
                                <label>Start Time</label>
                                <input type="time" class="form-control" @bind="bindStartTime" />
                            </div>
                            <div class="form-group">
                                <label>End Time</label>
                                <input type="time" class="form-control" @bind="bindEndTime" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Comment/Progress Description</label>
                                <textarea class="form-control" rows="12" @bind="currentProductivity.ProductivityComment"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" @onclick="CloseProductivityModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveProductivity">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showViewTaskModal)
{
    <div class="modal fade show" style="display: block; padding-right: 17px;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">View Task Details</h4>
                    <button type="button" class="close" @onclick="CloseViewTaskModal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Task</label>
                        <input type="text" class="form-control" value="@currentTask.Task" readonly />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" rows="5" readonly>@currentTask.Description</textarea>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" class="form-control" value="@currentTask.DateCreated.ToString("dd/MM/yyyy")" readonly />
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <input type="text" class="form-control" value="@(currentTask.Status == 0 ? "Pending" : (currentTask.Status == 1 ? "In-Progress" : "Done"))" readonly />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseViewTaskModal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (showViewProductivityModal)
{
    <div class="modal fade show" style="display: block; padding-right: 17px;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">View Productivity Details</h4>
                    <button type="button" class="close" @onclick="CloseViewProductivityModal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Project Task</label>
                                <input type="text" class="form-control" value="@(taskNames.ContainsKey(currentProductivity.ProductivityTaskId ?? 0) ? taskNames[currentProductivity.ProductivityTaskId ?? 0] : "-")" readonly />
                            </div>
                            <div class="form-group">
                                <label>Subject</label>
                                <input type="text" class="form-control" value="@currentProductivity.ProductivitySubject" readonly />
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="text" class="form-control" value="@currentProductivity.ProductivityDate?.ToString("dd/MM/yyyy")" readonly />
                            </div>
                            <div class="form-group">
                                <label>User</label>
                                <input type="text" class="form-control" value="@(userNames.ContainsKey(currentProductivity.ProductivityUserId ?? 0) ? userNames[currentProductivity.ProductivityUserId ?? 0] : "Unknown")" readonly />
                            </div>
                            <div class="form-group">
                                <label>Time Rendered (Hours)</label>
                                <input type="text" class="form-control" value="@(currentProductivity.ProductivityTimeRendered?.ToString("0.00") ?? "0.00")" readonly />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Comment/Progress Description</label>
                                <textarea class="form-control" rows="12" readonly>@currentProductivity.ProductivityComment</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseViewProductivityModal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@* Email Detail Modal *@
@if (showEmailModal && selectedEmail != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Email Details</h5>
                    <button type="button" class="close" @onclick="CloseEmailModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>From:</strong></label>
                                <p class="form-control-plaintext">@selectedEmail.EmailFrom</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>To:</strong></label>
                                <p class="form-control-plaintext">@(selectedEmail.EmailTo ?? "-")</p>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Received Date:</strong></label>
                                <p class="form-control-plaintext">@selectedEmail.ReceivedDate.ToString("dd-MM-yyyy HH:mm")</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>WR Number:</strong></label>
                                <p class="form-control-plaintext">
                                    @if (selectedEmail.IsMatched)
                                    {
                                        <span class="badge badge-success">@selectedEmail.ProjectWr</span>
                                        <span class="text-muted ml-2">(Matched to project)</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-warning">@(selectedEmail.ProjectWr ?? "None")</span>
                                        <span class="text-muted ml-2">(Not matched)</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><strong>Subject:</strong></label>
                        <p class="form-control-plaintext">@selectedEmail.EmailSubject</p>
                    </div>
                    
                    @* Attachments Section *@
                    @if (emailAttachments.ContainsKey(selectedEmail.EmailId) && emailAttachments[selectedEmail.EmailId].Any())
                    {
                        <div class="form-group">
                            <label><strong>Attachments:</strong></label>
                            <div class="list-group">
                                @foreach (var attachment in emailAttachments[selectedEmail.EmailId])
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-file mr-2"></i>
                                            <strong>@attachment.FileName</strong>
                                            <small class="text-muted ml-2">(@FormatFileSize(attachment.FileSize))</small>
                                        </div>
                                        <a href="/@attachment.FilePath" download="@attachment.FileName" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    <div class="form-group">
                        <label><strong>Email Body:</strong></label>
                        @if (!string.IsNullOrWhiteSpace(selectedEmail.EmailBodyHtml))
                        {
                            <div class="border p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                @((MarkupString)selectedEmail.EmailBodyHtml)
                            </div>
                        }
                        else if (!string.IsNullOrWhiteSpace(selectedEmail.EmailBody))
                        {
                            <textarea class="form-control" rows="10" readonly>@selectedEmail.EmailBody</textarea>
                        }
                        else
                        {
                            <p class="text-muted">No email body content</p>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEmailModal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    // ISO Forms state
    private List<ProjectChecklist>? projectChecklists;
    private List<ChecklistTemplate>? availableTemplates;
    private bool showStartChecklistModal = false;
    private int selectedTemplateId = 0;



    // New ISO Forms Logic
    private async Task LoadChecklists()
    {
         projectChecklists = await ChecklistService.GetProjectChecklistsAsync(ProjectId);
    }

    private void OpenStartChecklistModal()
    {
        // Load templates if not loaded
        if (availableTemplates == null)
        {
             InvokeAsync(async () => 
             {
                 availableTemplates = await ChecklistService.GetAllTemplatesAsync();
                 showStartChecklistModal = true;
                 StateHasChanged();
             });
        }
        else
        {
            showStartChecklistModal = true;
        }
    }

    private void CloseStartChecklistModal()
    {
        showStartChecklistModal = false;
        selectedTemplateId = 0;
    }

    private async Task StartChecklist()
    {
        if (selectedTemplateId == 0) return;
        
        var user = await GetCurrentUser();
        var checklist = await ChecklistService.StartChecklistAsync(ProjectId, selectedTemplateId, user.Identity?.Name ?? "System");
        
        CloseStartChecklistModal();
        Navigation.NavigateTo($"/iso-forms/run/{checklist.ChecklistInstanceId}");
    }

    private async Task SaveChecklistToFiles(ProjectChecklist checklist)
    {
        try 
        {
            // 1. Generate HTML
            // Ensure specific checklist is fully loaded with responses if needed, but the list one might be partial?
            // "GetProjectChecklistsAsync" includes Template but maybe not fully nested questions/responses?
            // Actually it does not include Sections/Questions/Responses in the list call usually for performance.
            // So we fetch the full instance first.
            
            var fullChecklist = await ChecklistService.GetChecklistInstanceAsync(checklist.ChecklistInstanceId);
            if(fullChecklist == null) return;
            
            string html = HtmlExportService.GenerateChecklistHtml(fullChecklist, project);
            byte[] content = System.Text.Encoding.UTF8.GetBytes(html);
            
            // 2. Save to File System
            var user = await GetCurrentUser();
            string userId = user.Identity?.Name ?? "System";
            
            string fileName = $"Checklist_{fullChecklist.Template?.Name ?? "Unknown"}_{fullChecklist.CreatedDate:yyyyMMdd}_{fullChecklist.ChecklistInstanceId}.html";
            // Sanitize filename
            fileName = string.Join("_", fileName.Split(System.IO.Path.GetInvalidFileNameChars()));
            
            await FileSystemService.SaveFileContentAsync(ProjectId, "Checklists", fileName, content, userId);
            
            await JSRuntime.InvokeVoidAsync("Notifications.showSuccess", "Checklist saved to project files successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Notifications.showError", $"Failed to save checklist: {ex.Message}");
        }
    }

    // ... [Existing Methods] ...
    
    private void ViewEmail(ProjectEmail email)
    {
        selectedEmail = email;
        showEmailModal = true;
    }

    private void CloseEmailModal()
    {
        showEmailModal = false;
        selectedEmail = null;
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private async Task ScrollToEmails()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('project-emails').scrollIntoView({ behavior: 'smooth', block: 'start' });");
    }

    private string GetQuoteUrl(string value)
    {
        if (string.IsNullOrEmpty(value)) return "#";
        var digits = new string(value.Where(char.IsDigit).ToArray());
        return $"https://qts.epw.qld.gov.au/Quotes/edit/{digits}";
    }

    private async Task<System.Security.Claims.ClaimsPrincipal> GetCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        return authState.User;
    }
}
