@page "/projects/edit/{ProjectId:int}"
@using CopelinSystem.Models
@using CopelinSystem.Services
@inject ProjectService ProjectService
@inject ClientService ClientService
@inject ConsultantService ConsultantService
@inject ContractorService ContractorService
@inject EmployeeService EmployeeService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthenticationService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Edit Project - Copelin Work Flow Management</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="container-fluid mt-3">
            @if (project == null)
            {
                <div class="text-center">
                    <p>Loading project...</p>
                </div>
            }
            else
            {
                <!-- Header Section -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h3>Edit Project</h3>
                    </div>
                    <div class="col-md-6 text-right">
                        <button class="btn btn-success" @onclick="SaveProject"><i class="fas fa-save"></i> Save Changes</button>
                        <button class="btn btn-secondary" @onclick="Cancel"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                </div>

                <!-- Edit Form -->
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Project Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>Project Name *</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectName" required />
                                </div>

                                <div class="form-group">
                                    <label><strong>WR Number</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectWr" disabled="@(!canEditWr)" />
                                    @if (!canEditWr)
                                    {
                                        <small class="text-muted">Only Admin and Principal Estimator can edit this field</small>
                                    }
                                </div>

                                <div class="form-group">
                                    <label><strong>Date Created</strong></label>
                                    <input type="text" class="form-control" value="@project.ProjectDateCreated.ToString("dd/MM/yyyy")" disabled />
                                    <small class="text-muted">This field cannot be modified</small>
                                </div>

                                <div class="form-group">
                    <label><strong>Description</strong></label>
                    <textarea class="form-control" rows="3" @bind="project.ProjectDescription"></textarea>
                </div>

                <div class="form-group">
                    <label><strong>Location</strong></label>
                    <input type="text" class="form-control" @bind="project.ProjectLocation" />
                </div>

                <div class="form-group">
                    <label><strong>Client Required Date</strong></label>
                    <input type="date" class="form-control" @bind="project.ProjectClientRequired" />
                </div>

                <div class="form-group">
                    <label><strong>Client Completion Date</strong></label>
                    <input type="date" class="form-control" @bind="project.ProjectClientCompletion" />
                </div>

                <!-- Client Information Section (Grouped) -->
                <div class="card bg-light p-3 mb-3">
                    <h5 class="mb-3">Client Information</h5>
                      @if (currentUser != null && AuthService.IsManagerOrHigher(currentUser))
                      {
                    <div class="form-group">
                        <label><strong>Region</strong></label>
                        <select class="form-control" @bind="selectedRegionId" @bind:after="OnRegionChanged">
                            <option value="0">-- Select Region --</option>
                            @if (regions != null)
                            {
                                foreach (var region in regions)
                                {
                                    <option value="@region.RegionId">@region.RegionName</option>
                                }
                            }
                        </select>                        
                    </div>
                    }

                    <div class="form-group">
                        <label><strong>Project Region</strong></label>
                        <input type="text" class="form-control" @bind="project.ProjectRegion" readonly />
                        <small class="text-muted">This field is automatically updated based on the selected Region.</small>
                    </div>

                    <div class="form-group">
                        <label><strong>Client</strong></label>
                        <select class="form-control" @bind="selectedClientId" @bind:after="OnClientChanged" disabled="@(selectedRegionId == 0)">
                            <option value="0">-- Select Client --</option>
                            @if (filteredClients != null)
                            {
                                foreach (var client in filteredClients)
                                {
                                    <option value="@client.ClientId">@client.ClientCode - @client.ClientName</option>
                                }
                            }
                        </select>
                        @if (selectedRegionId == 0)
                        {
                            <small class="text-muted">Please select a region first</small>
                        }
                    </div>

                    <div class="form-group">
                        <label><strong>Client Contact</strong></label>
                        <select class="form-control" @bind="selectedContactId" @bind:after="OnContactChanged" disabled="@(selectedClientId == 0)">
                            <option value="0">-- Select Contact --</option>
                            @if (clientContacts != null)
                            {
                                foreach (var contact in clientContacts)
                                {
                                    <option value="@contact.ClientContactId">@contact.ContactName @(contact.IsPrimary ? "(Primary)" : "")</option>
                                }
                            }
                        </select>
                        @if (selectedClientId == 0)
                        {
                            <small class="text-muted">Please select a client first</small>
                        }
                    </div>

                    <div class="form-group">
                        <label><strong>Contact Email</strong></label>
                        <input type="email" class="form-control" @bind="project.ProjectContactEmail" readonly="@(selectedContactId == 0)" />
                        @if (selectedContactId == 0)
                        {
                            <small class="text-muted">Select a contact to auto-fill email</small>
                        }
                    </div>
                </div>
                                <div class="form-group">
                                    <label><strong>Consultant</strong></label>
                                    <select class="form-control" @bind="project.ProjectConsultant">
                                        <option value="">-- Select Consultant --</option>
                                        @if (consultants != null)
                                        {
                                            foreach (var consultant in consultants)
                                            {
                                                <option value="@consultant.BusinessName">@consultant.BusinessName</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label><strong>Contractor</strong></label>
                                    <select class="form-control" @bind="project.ProjectContractor">
                                        <option value="">-- Select Contractor --</option>
                                        @if (contractors != null)
                                        {
                                            foreach (var contractor in contractors)
                                            {
                                                <option value="@contractor.BusinessName">@contractor.BusinessName</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label><strong>Works Type</strong></label>
                                    <InputSelect @bind-Value="project.ProjectWorkstype" class="form-control">
                                        <option value="">-- Select Works Type --</option>
                                        <option value="Fee Proposal">Fee Proposal</option>
                                        <option value="Delivery">Delivery</option>
                                        <option value="Indicative">Indicative</option>
                                        <option value="Quantity Survey">Quantity Survey</option>
                                        <option value="Other Works">Other Works</option>
                                    </InputSelect>
                                </div>

                                @if (currentUser != null && AuthService.IsManagerOrHigher(currentUser))
                                {
                                    <div class="form-group">
                                        <label><strong>Project Team</strong> (Hold Ctrl/Cmd to select multiple)</label>
                                        <select multiple class="form-control" @bind="SelectedUserIds" style="height: 150px;" disabled="@(selectedRegionId == 0)">
                                            @if (filteredUsers != null && filteredUsers.Any())
                                            {
                                                foreach (var user in filteredUsers)
                                                {
                                                    <option value="@user.UserId">@user.Firstname @user.Lastname</option>
                                                }
                                            }
                                        </select>
                                        @if (selectedRegionId == 0)
                                        {
                                            <small class="form-text text-muted">Please select a region first to see available team members.</small>
                                        }
                                        <small class="form-text text-muted">Assign users to this project. Selected users will see this project on their dashboard.</small>
                                    </div>
                                }
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>Estimated Completion</strong></label>
                                    <input type="date" class="form-control" @bind="project.ProjectEndDate" readonly/>
                                </div>

                                <div class="form-group">
                                    <label><strong>Estimators Start Date</strong></label>
                                    <input type="date" class="form-control" @bind="project.ProjectStartDate" />
                                </div>

                                <div class="form-group">
                                    <label><strong>Componentisation</strong></label>
                                    <select class="form-control" @bind="project.ProjectComponentisation">
                                        <option value="">-- Select --</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label><strong>Fee Proposal</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectFeeprop" />
                                </div>

                                <div class="form-group">
                                    <label><strong>Work Order Number</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectWo" />
                                </div>

                                <div class="form-group">
                                    <label><strong>REQ Order</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectReqOrder" />
                                </div>

                                <div class="form-group">
                                    <label><strong>One School</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectOneSchool" />
                                </div>

                                <div class="form-group">
                                    <label><strong>Folder Path</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectFolderPath" />
                                </div>

                                <div class="form-group">
                                    <label><strong>Supervisor</strong></label>
                                    <select class="form-control" @bind="project.ProjectSupervisor">
                                        <option value="">-- Select Supervisor --</option>
                                        @if (supervisors != null)
                                        {
                                            foreach (var supervisor in supervisors)
                                            {
                                                <option value="@supervisor.FullName">@supervisor.FullName @(supervisor.Region != null ? $"({supervisor.Region.RegionName})" : "")</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label><strong>Principal Estimator</strong></label>
                                    <select class="form-control" @bind="project.ProjectSeniorEstimator">
                                        <option value="">-- Select Senior Estimator --</option>
                                        @if (seniorEstimators != null)
                                        {
                                            foreach (var estimator in seniorEstimators)
                                            {
                                                <option value="@estimator.FullName">@estimator.FullName @(estimator.Region != null ? $"({estimator.Region.RegionName})" : "")</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label><strong>Ellipse Status</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectEllipesStatus" />
                                </div>

                                <div class="form-group">
                                    <label><strong>Purchase Order</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectPurchaseOrder" />
                                </div>

                                <div class="form-group">
                                    <label><strong>IRIS No</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectIrisNo" />
                                </div>

                                <div class="form-group">
                                    <label><strong>eTender No</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectEtenderNo" />
                                </div>

                                <div class="form-group">
                                    <label><strong>WIC No</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectWicNo" />
                                </div>

                                <div class="form-group">
                                    <label><strong>Program Code</strong></label>
                                    <input type="text" class="form-control" @bind="project.ProjectProgramCode" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h3>Please log in to edit projects.</h3>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectList? project;
    private User? currentUser;
    private bool canEditWr = false;
    private List<Client>? clients;
    private List<Client>? filteredClients;
    private List<ClientContact>? clientContacts;
    private List<Region>? regions;
    private List<Consultant>? consultants;
    private List<Contractor>? contractors;
    private List<Employee>? supervisors;
    private List<Employee>? seniorEstimators;
    private List<User>? allUsers;
    private List<User> filteredUsers = new();
    
    private string[] SelectedUserIds
    {
        get
        {
            if (string.IsNullOrEmpty(project?.ProjectUserIds))
                return Array.Empty<string>();
            return project.ProjectUserIds.Split(',', StringSplitOptions.RemoveEmptyEntries);
        }
        set
        {
            if (project != null)
            {
                project.ProjectUserIds = string.Join(",", value);
            }
        }
    }
    
    // Cascading lookup state
    private int selectedRegionId = 0;
    private int selectedClientId = 0;
    private int selectedContactId = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUser = await AuthService.GetUserById(userId);
                
                // Check if user can edit WR field (Admin or Principal Estimator)
                if (currentUser != null)
                {
                    canEditWr = currentUser.Role == UserRole.Admin || currentUser.Role == UserRole.PrincipalEstimator;
                }
            }
        }

        // Load project
        project = await ProjectService.GetProjectById(ProjectId);
        
        // Load regions for cascading dropdown
        regions = await EmployeeService.GetAllRegions();
        
        // Load all clients
        clients = await ClientService.GetAllClients();
        
        // Load consultants for dropdown
        consultants = await ConsultantService.GetAllConsultants();
        
        // Load contractors for dropdown
        contractors = await ContractorService.GetAllContractors();
        
        // Load supervisors for dropdown
        supervisors = await EmployeeService.GetSupervisors();
        
        // Load senior estimators for dropdown
        seniorEstimators = await EmployeeService.GetSeniorEstimators();

        // Load all users for Project Team assignment (only needed for Managers+)
        if (currentUser != null && AuthService.IsManagerOrHigher(currentUser))
        {
            allUsers = await AuthService.GetAllUsers();
        }
        
        // Initialize cascading lookups based on existing project data (must be after loading all data including users)
        await InitializeCascadingLookups();
    }

    private async Task InitializeCascadingLookups()
    {
        if (project == null || clients == null || regions == null) return;

        // Try to find the client by ClientName (stored in ProjectClient)
        var existingClient = clients.FirstOrDefault(c => c.ClientName == project.ProjectClient);
        
        if (existingClient != null)
        {
            selectedClientId = existingClient.ClientId;
            
            // Set region if client has one
            if (existingClient.RegionId.HasValue)
            {
                selectedRegionId = existingClient.RegionId.Value;
                
                // Filter clients by region without clearing fields
                filteredClients = clients.Where(c => c.RegionId == selectedRegionId).ToList();
            }
            
            // Load contacts for the selected client
            clientContacts = await ClientService.GetClientContactsByClient(selectedClientId);
            
            // Try to find and select the existing contact
            if (!string.IsNullOrEmpty(project.ProjectContact))
            {
                var existingContact = clientContacts.FirstOrDefault(c => c.ContactName == project.ProjectContact);
                if (existingContact != null)
                {
                    selectedContactId = existingContact.ClientContactId;
                }
            }
        }
        
        // Filter users by region if region is set
        if (selectedRegionId > 0 && allUsers != null && regions != null)
        {
            var selectedRegion = regions.FirstOrDefault(r => r.RegionId == selectedRegionId);
            if (selectedRegion != null)
            {
                filteredUsers = allUsers.Where(u => u.Region == selectedRegion.RegionName).ToList();
            }
        }
        else if (allUsers != null)
        {
            filteredUsers = new List<User>();
        }
        
        // If region still not set but ProjectRegion exists, try to match region by name
        if (selectedRegionId == 0 && !string.IsNullOrEmpty(project.ProjectRegion) && regions != null)
        {
            var existingRegion = regions.FirstOrDefault(r => r.RegionName == project.ProjectRegion);
            if (existingRegion != null)
            {
                selectedRegionId = existingRegion.RegionId;
                filteredClients = clients.Where(c => c.RegionId == selectedRegionId).ToList();
                
                // Filter users by this region
                if (allUsers != null)
                {
                    filteredUsers = allUsers.Where(u => u.Region == existingRegion.RegionName).ToList();
                }
            }
        }
    }

    private async Task OnRegionChanged()
    {
        // Filter clients by selected region
        if (selectedRegionId > 0 && clients != null)
        {
            filteredClients = clients.Where(c => c.RegionId == selectedRegionId).ToList();
            
            // Update project region name
            if (project != null && regions != null)
            {
                var selectedRegion = regions.FirstOrDefault(r => r.RegionId == selectedRegionId);
                if (selectedRegion != null)
                {
                    project.ProjectRegion = selectedRegion.RegionName;
                }
            }
        }
        else
        {
            filteredClients = new List<Client>();
            filteredUsers = new List<User>();
            
            // Clear project region
            if (project != null)
            {
                project.ProjectRegion = "";
            }
        }
        
        // Filter users by region
        if (selectedRegionId > 0 && allUsers != null && regions != null)
        {
            var selectedRegion = regions.FirstOrDefault(r => r.RegionId == selectedRegionId);
            if (selectedRegion != null)
            {
                filteredUsers = allUsers.Where(u => u.Region == selectedRegion.RegionName).ToList();
            }
        }
        
        // Reset client and contact selections
        selectedClientId = 0;
        selectedContactId = 0;
        clientContacts = new List<ClientContact>();
        
        // Clear client and contact fields
        if (project != null)
        {
            project.ProjectClient = "";
            project.ProjectContact = "";
            project.ProjectContactEmail = "";
        }
        
        await Task.CompletedTask;
    }

    private async Task OnClientChanged()
    {
        // Load contacts for selected client
        if (selectedClientId > 0)
        {
            clientContacts = await ClientService.GetClientContactsByClient(selectedClientId);
            
            // Update project client name (not code)
            if (project != null && filteredClients != null)
            {
                var selectedClient = filteredClients.FirstOrDefault(c => c.ClientId == selectedClientId);
                if (selectedClient != null)
                {
                    project.ProjectClient = selectedClient.ClientName; // Changed from ClientCode to ClientName
                }
            }
        }
        else
        {
            clientContacts = new List<ClientContact>();
        }
        
        // Reset contact selection
        selectedContactId = 0;
        
        // Clear contact fields
        if (project != null)
        {
            project.ProjectContact = "";
            project.ProjectContactEmail = "";
        }
    }

    private async Task OnContactChanged()
    {
        // Update project contact fields
        if (selectedContactId > 0 && clientContacts != null && project != null)
        {
            var selectedContact = clientContacts.FirstOrDefault(cc => cc.ClientContactId == selectedContactId);
            if (selectedContact != null)
            {
                project.ProjectContact = selectedContact.ContactName;
                project.ProjectContactEmail = selectedContact.ContactEmail ?? "";
            }
        }
        else if (project != null)
        {
            project.ProjectContact = "";
            project.ProjectContactEmail = "";
        }
        
        await Task.CompletedTask;
    }

    private async Task SaveProject()
    {
        if (project == null) return;

        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to save these changes?");
        if (confirmed)
        {
            await ProjectService.UpdateProject(project);
            await JSRuntime.InvokeVoidAsync("alert", "Project updated successfully!");
            Navigation.NavigateTo($"/projects/view/{ProjectId}");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/projects/view/{ProjectId}");
    }
}
