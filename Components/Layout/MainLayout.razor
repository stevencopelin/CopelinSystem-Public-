@inherits LayoutComponentBase
@using CopelinSystem.Services
@using CopelinSystem.Models
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthenticationService AuthService
@inject PermissionService PermissionService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<AuthorizeView>
    <Authorized>
        <div class="wrapper">
            <!-- Navbar -->
            <nav class="main-header navbar navbar-expand navbar-dark navbar-flatly">
                <!-- Left navbar links -->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-widget="pushmenu" href="javascript:void(0)" role="button">
                            <i class="fas fa-bars"></i>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link text-white" href="/" role="button">
                            <large><b>@systemName</b></large>
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" id="fullscreen-btn" href="javascript:void(0)" role="button" title="Fullscreen">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </a>
                    </li>

                    <!-- Online Users Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link" data-toggle="dropdown" href="javascript:void(0)" title="Who's Online">
                            <i class="fa fa-users"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right p-2" style="min-width:200px;">
                            <strong>Online Users</strong>
                            <ul class="list-unstyled mb-0">
                                @if (onlineUsers?.Any() == true)
                                {
                                    @foreach (var user in onlineUsers)
                                    {
                                        <li><i class="fa fa-user text-success"></i> @user.DisplayName</li>
                                    }
                                }
                                else
                                {
                                    <li class="text-muted">No users online</li>
                                }
                            </ul>
                        </div>
                    </li>

                    <!-- User Account Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link" data-toggle="dropdown" href="javascript:void(0)">
                            <span>
                                <div class="d-flex badge-pill">
                                    <span class="fa fa-user"></span>
                                    <span class="ml-2"><b>@currentUser?.Firstname</b></span>
                                    <span class="fa fa-angle-down ml-2"></span>
                                </div>
                            </span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="/account/manage">
                                <i class="fa fa-cog"></i> Manage Account
                            </a>
                            <a class="dropdown-item" href="/logout">
                                <i class="fa fa-power-off"></i> Logout
                            </a>
                        </div>
                    </li>
                </ul>
            </nav>
            <!-- /.navbar -->
            <!-- Main Sidebar Container -->
            <aside class="main-sidebar sidebar-dark-primary elevation-4">
                <div class="dropdown">
                    <a href="/" class="brand-link">
                        <center>
                            <h3 class="text-white">@GetUserInitials()</h3>
                        </center>
                    </a>
                </div>

                <div class="sidebar pb-4 mb-4">
                    <nav class="mt-2">
                        <ul class="nav nav-pills nav-sidebar flex-column nav-flat" data-widget="treeview" role="menu" data-accordion="false">

                            <!-- Dashboard -->
                            <li class="nav-item">
                                <a href="/" class="nav-link @(IsActive("/") ? "active" : "")">
                                    <i class="nav-icon fas fa-tachometer-alt"></i>
                                    <p>Dashboard</p>
                                </a>
                            </li>

                            <!-- Project List (Explorer) -->
                            <li class="nav-item">
                                <a href="/projects" class="nav-link @(IsActive("/projects") ? "active" : "")">
                                    <i class="nav-icon fas fa-list"></i>
                                    <p>Project List</p>
                                </a>
                            </li>

                            <!-- Add Project -->
                            @if (canCreateProjects)
                            {
                                <li class="nav-item">
                                    <a href="/projects/add" class="nav-link @(IsActive("/projects/add") ? "active" : "")">
                                        <i class="nav-icon fas fa-plus-circle"></i>
                                        <p>Add Project</p>
                                    </a>
                                </li>
                            }

                            <!-- User Management Dropdown (Admin/Manager) -->
                        @if (canManageUsers || canManageEmployees || canManageClients || canManageConsultants || canManageContractors)
                        {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-users-cog mr-2"></i> Management
                                </a>
                                <div class="dropdown-menu" aria-labelledby="userDropdown">
                                    @if (canManageEmployees)
                                    {
                                        <a class="dropdown-item" href="/employees">
                                            <i class="fas fa-user-tie mr-2"></i> Employee Management
                                        </a>
                                    }
                                    @if (canManageUsers)
                                    {
                                        <a class="dropdown-item" href="/users">
                                            <i class="fas fa-users mr-2"></i> User Management
                                        </a>
                                        <a class="dropdown-item" href="/permissions">
                                            <i class="fas fa-user-shield mr-2"></i> Permission Management
                                        </a>
                                    }
                                    
                                    @if (canManageEmployees || canManageUsers)
                                    {
                                        <div class="dropdown-divider"></div>
                                    }
                                    
                                    @if (canManageClients)
                                    {
                                        <a class="dropdown-item" href="/clients">
                                            <i class="fas fa-building mr-2"></i> Client Management
                                        </a>
                                    }
                                    @if (canManageConsultants)
                                    {
                                        <a class="dropdown-item" href="/consultants">
                                            <i class="fas fa-hard-hat mr-2"></i> Consultant Management
                                        </a>
                                    }
                                    @if (canManageContractors)
                                    {
                                        <a class="dropdown-item" href="/contractors">
                                            <i class="fas fa-truck mr-2"></i> Contractor Management
                                        </a>
                                    }
                                </div>
                            </li>
                        }    


                        </ul>
                    </nav>
                </div>
            </aside>

            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <div class="content">
                    @Body
                </div>
            </div>

            <!-- Footer -->
            <footer class="main-footer">
                <strong> @DateTime.Now.Year <a href="#">Copelin System</a> - </strong>
                Qld Governement - QBuild.
                <div class="float-right d-none d-sm-inline-block">
                    <b>Version</b> 2.0.0
                </div>
            </footer>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <h3>Authentication Required</h3>
                            <p class="text-muted">Please authenticate with Windows to access this application.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private User? currentUser;
    private List<User>? onlineUsers;
    private string systemName = "Copelin Work Flow Management";
    private string currentPath = "";

    private bool canManageUsers = false;
    private bool canManageEmployees = false;
    private bool canManageClients = false;
    private bool canManageConsultants = false;
    private bool canManageContractors = false;
    private bool canCreateProjects = false;

    protected override async Task OnInitializedAsync()
    {
        currentPath = Navigation.Uri.Replace(Navigation.BaseUri, "/");

        // Get online users (active in last 15 minutes)
        onlineUsers = await AuthService.GetAllUsers();
        onlineUsers = onlineUsers
            .Where(u => u.LastActive.HasValue &&
                        u.LastActive.Value > DateTime.Now.AddMinutes(-15))
            .ToList();
    }

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                currentUser = await AuthService.GetUserById(userId);
                if (currentUser != null)
                {
                    canManageUsers = await PermissionService.UserHasPermission(currentUser, "ManageUsers");
                    canManageEmployees = await PermissionService.UserHasPermission(currentUser, "ManageEmployees");
                    canManageClients = await PermissionService.UserHasPermission(currentUser, "ManageClients");
                    canManageConsultants = await PermissionService.UserHasPermission(currentUser, "ManageConsultants");
                    canManageContractors = await PermissionService.UserHasPermission(currentUser, "ManageContractors");
                    canCreateProjects = await PermissionService.UserHasPermission(currentUser, "CreateProjects");
                }
            }
        }
    }

    private string GetUserInitials()
    {
        if (currentUser == null) return "??";

        var names = currentUser.DisplayName.Split(' ');
        var initials = "";
        foreach (var name in names)
        {
            if (!string.IsNullOrEmpty(name))
                initials += name[0].ToString().ToUpper();
        }
        return initials;
    }

    private bool IsActive(string path)
    {
        return currentPath.Equals(path, StringComparison.OrdinalIgnoreCase);
    }

    private bool IsParentActive(string path)
    {
        return currentPath.StartsWith(path, StringComparison.OrdinalIgnoreCase);
    }
}